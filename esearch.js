var used_variables,cats;let filter_expr=document.getElementById("filter-expr"),sort_expr=document.getElementById("sort-expr"),search_result=document.getElementById("search-result"),tbody=document.getElementById("tbody"),pages_a=document.getElementById("pages-a");var hide_seach=!1,last_forms;let tables=document.getElementById("tables"),toggle_s=document.getElementById("toggle-s"),trait_s=document.getElementById("trait-s"),atk_s=document.getElementById("atk-s"),ab_s=document.getElementById("ab-s"),kind_s=document.getElementById("kind-s"),atkBtn=atk_s.firstElementChild.firstElementChild,traitBtn=trait_s.firstElementChild.firstElementChild,abBtn=ab_s.firstElementChild.firstElementChild,name_search=document.getElementById("name-search");var per_page=10;function rerender(event){event.preventDefault();var id=event.currentTarget._i;if(pages_a.textContent="",9<=id){let i=0;var maxPage=Math.min(Math.ceil(last_forms.length/per_page),id+7);for(let c=id-2;c<=maxPage;++c){var td=document.createElement("td");if(td.textContent=c.toString(),td.onclick=rerender,(td._i=c)==id&&(td.classList.add("N"),td.onclick=null),pages_a.appendChild(td),10<=++i)break}}renderTable(last_forms,id)}function setRange(e){per_page=parseInt(e.currentTarget.value),renderTable(last_forms)}function renderTable(forms,page=1){var H=page*per_page,display_forms=forms.slice(H-per_page,H);if(tbody.textContent="",search_result.textContent=`顯示第${H-per_page+1}到第${Math.min(forms.length,H)}個結果，共有${forms.length}個結果`,0==(last_forms=forms).length)tbody.innerHTML='<tr><td colSpan="13">沒有符合調件的敵人!</td></tr>';else{if(!pages_a.children.length){let c=1;for(let i=0;i<forms.length;i+=per_page){var td=document.createElement("td");if(td.textContent=c.toString(),td.onclick=rerender,page==(td._i=c)&&(td.classList.add("N"),td.onclick=null),pages_a.appendChild(td),10<=c++)break}}for(let i=0;i<display_forms.length;++i){var tr=document.createElement("tr"),theForm=display_forms[i][1],texts=[theForm.id-2,"",theForm.name||theForm.jp_name||"?",~~theForm.gethp(),~~theForm.getatk(),~~theForm.getdps(),theForm.kb,theForm.range,numStrT(theForm.attackF).replace("秒","秒/下"),theForm.speed,theForm.earn,numStr(display_forms[i][0])];for(let j=0;j<texts.length;++j){var e=document.createElement("td");e.textContent=texts[j].toString(),tr.appendChild(e)}var a=document.createElement("a"),img=new Image(64,64),ss=t3str(theForm.id-2);img.src="/img/e/"+ss+"/enemy_icon_"+ss+".png",a.href="./enemy.html?id="+(theForm.id-2).toString(),a.appendChild(img),tr.children[1].appendChild(a),tbody.appendChild(tr)}}}function simplify(code){return code.replaceAll("\n","").replaceAll(" ","").replaceAll("\r","").replaceAll("\t","")}function calculate(code=""){pages_a.textContent="";let sortCode=simplify(sort_expr.value),url=new URL(location.pathname,location.href);if(code.length){if(!code.length)return renderTable([]);url.searchParams.set("filter",code)}else{let codes=[],traits=Array.from(trait_s.querySelectorAll(".o-selected"));if(traits.length){let M=traits.map(x=>x.getAttribute("data-expr"));url.searchParams.set("traits",M.join(" ")),"OR"==traitBtn.textContent?codes.push(M.join("||")):codes.push(M.join("&&"))}let kinds=Array.from(kind_s.querySelectorAll(".o-selected"));if(kinds.length){let M=kinds.map(x=>x.getAttribute("data-expr"));url.searchParams.set("kinds",M.join(" ")),codes.push(M.join("||"))}let atks=Array.from(atk_s.querySelectorAll(".o-selected"));if(atks.length){let M=atks.map(x=>x.getAttribute("data-expr"));url.searchParams.set("atks",M.join(" ")),"OR"==atkBtn.textContent?codes.push(M.join("||")):codes.push(M.join("&&"))}let abs=Array.from(ab_s.querySelectorAll(".o-selected"));if(abs.length){let M=abs.map(x=>x.getAttribute("data-expr"));url.searchParams.set("abs",M.join(" ")),"OR"==abBtn.textContent?codes.push(M.join("||")):codes.push(M.join("&&"))}code=codes.length?filter_expr.value=codes.map(x=>`(${x})`).join("&&"):"1"}var pcode;try{pcode=pegjs.parse(code)}catch(e){alert(e.toString())}let f=eval(`form => (${pcode})`);results=cats.filter(f);try{pcode=pegjs.parse(sortCode||"1")}catch(e){alert(e.toString())}let fn=eval(`form => (${pcode})`),a=(results=results.map((form,i)=>{var x=fn(form);return[isFinite(x)?x:0,form]}).sort((a,b)=>b[0]-a[0]),renderTable(results),sortCode.length&&url.searchParams.set("sort",sortCode),"OR"==atkBtn.textContent?"1":"0"),b="OR"==traitBtn.textContent?"1":"0",c="OR"==abBtn.textContent?"1":"0";url.searchParams.set("ao",a+b+c),history.pushState({},"",url)}function addBtns(parent,s){if(s){var c;s.split(" ");for(c of parent.querySelectorAll("button"))s.includes(c.parentNode.getAttribute("data-expr"))&&c.parentNode.classList.add("o-selected")}}loadAllEnemies().then(_cats=>{cats=_cats;var sort,_cats=new URLSearchParams(location.search),Q=(document.getElementById("loader").style.display="none",document.getElementById("loader-text").style.display="none",document.getElementById("main").style.display="block",_cats.get("q"));Q?(name_search.value=Q,name_search.oninput(),history.pushState({},"","/esearch.html")):(Q=_cats.get("filter"),sort=_cats.get("sort"),Q&&(filter_expr.value=Q),sort&&(sort_expr.value=sort),(sort=_cats.get("ao"))&&(atkBtn.textContent="1"==sort[0]?"OR":"AND",traitBtn.textContent="1"==sort[1]?"OR":"AND",abBtn.textContent="1"==sort[2]?"OR":"AND"),addBtns(atk_s,_cats.get("atks")),addBtns(ab_s,_cats.get("abs")),addBtns(trait_s,_cats.get("traits")),addBtns(kind_s,_cats.get("kinds")),calculate(Q||""))}),document.querySelectorAll("button").forEach(elem=>{elem.state="0",elem.addEventListener("click",function(event){event=event.currentTarget;"0"==event.state?(event.parentNode.classList.add("o-selected"),event.state="1"):(event.parentNode.classList.remove("o-selected"),event.state="0"),calculate()})}),document.querySelectorAll(".or-and").forEach(e=>{e.onclick=function(event){event=event.currentTarget;"OR"==event.textContent?event.textContent="AND":event.textContent="OR",calculate()}}),document.getElementById("filter-go").onclick=function(){calculate(simplify(filter_expr.value))},document.getElementById("filter-clear").onclick=function(){function fn(x){x.classList.remove("o-selected")}trait_s.querySelectorAll(".o-selected").forEach(fn),atk_s.querySelectorAll(".o-selected").forEach(fn),ab_s.querySelectorAll(".o-selected").forEach(fn),kind_s.querySelectorAll(".o-selected").forEach(fn),filter_expr.value="",sort_expr.value="",calculate()},toggle_s.onclick=function(){hide_seach?(tables.style.left="390px",tables.style.width="calc(100% - 400px)",document.documentElement.style.setProperty("--mhide","block"),toggle_s.textContent="隱藏搜尋器"):(document.documentElement.style.setProperty("--mhide","none"),tables.style.left="0px",tables.style.width="100%",toggle_s.textContent="顯示搜尋器"),hide_seach=!hide_seach},name_search.oninput=function(){var search=name_search.value.trim();if(search){let digit=1<=search.length;for(var c of search){c=c.codePointAt(0);(c<48||57<c)&&(digit=!1)}var C,s=cats.slice(2),results=[];if(digit){let x=parseInt(search);x<cats.length&&(results.push([1,s[x]]),s.splice(x,1))}for(C of s)(C.name&&C.name.includes(search)||C.jp_name&&C.jp_name.includes(search))&&results.push([1,C]);renderTable(results)}};let th=document.getElementById("th");for(let n of th.children)n.title&&(n._s=0,n._t=n.textContent,n.onclick=function(event){0==n._s?(n._s=1,sort_expr.value=event.currentTarget.title):(n._s=0,sort_expr.value="-"+event.currentTarget.title);var x,event=n._s;for(x of th.children)x.title&&(x.textContent=x._t,x._s=0);n._s=event,n.textContent=n._t+(n._s?"↑":"↓"),calculate(simplify(filter_expr.value))});