const my_params=new URLSearchParams(location.search);let cutfile=my_params.get("cutfile"),imgfile=my_params.get("imgfile");const canvas=document.getElementById("imgcut"),ctx=canvas.getContext("2d"),edit=document.getElementById("edit"),img=new Image,preview=document.getElementById("preview"),pctx=preview.getContext("2d");var last_t,cut,imgloaded=!1;img.crossOrigin="anonymous",img.onload=function(){canvas.width=this.naturalWidth,canvas.height=this.naturalHeight,ctx.drawImage(this,0,0,this.naturalWidth,this.naturalHeight),imgloaded=!0},img.onerror=function(){ctx.clearRect(0,0,canvas.width,canvas.height),ctx.fillText("導入圖片失敗",canvas.width/2,canvas.height/2),imgloaded=!1},imgfile?img.src=imgfile:(ctx.font="30px serif",ctx.textAlign="center",ctx.textBaseline="middle",ctx.fillText("導入圖片以開始",canvas.width/2,canvas.height/2)),cutfile?fetch(cutfile).then(res=>res.text()).then(text=>{cut=new ImgCut(text);for(let i=0;i<cut.cuts.length;++i)edit.appendChild(createLine(cut.cuts[i],i))}):cutfile="";class ImgCut{constructor(text){if(text){var arr=text.replaceAll("\r","").split("\n"),L=(this.name=arr[2],parseInt(arr[3]));let tmp;if(!isFinite(L)||5e3<L)throw"Invalid imgcut";this.cuts=new Array(L);for(let i=0;i<L;++i)if(tmp=arr[4+i]){tmp=tmp.split(",");var t=new Array(5);this.cuts[i]=t;for(let j=0;j<4;++j){let x=parseInt(tmp[j]);isFinite(x)||(x=0),t[j]=x}t[4]=tmp[4]||""}else this.cuts[i]=[0,0,1,1,""]}else this.name="",this.cuts=[]}}function draw(){if(imgloaded){let i=0;var nodes=edit.getElementsByClassName("ihover"),nodes=(nodes.length&&(i=Array.from(edit.children).indexOf(nodes[0])),ctx.lineWidth=2,ctx.clearRect(0,0,canvas.width,canvas.height),ctx.drawImage(img,0,0,img.naturalWidth,img.naturalHeight),cut.cuts[i]);ctx.strokeRect(nodes[0],nodes[1],nodes[2],nodes[3])}}function createLine(c,i){var tr=document.createElement("tr"),tdi=document.createElement("td"),tdx=document.createElement("td"),tdy=document.createElement("td"),tdw=document.createElement("td"),tdh=document.createElement("td"),tdn=document.createElement("td");return tdi.innerText=i,tdx.innerText=c[0],tdy.innerText=c[1],tdw.innerText=c[2],tdh.innerText=c[3],tdn.innerText=c[4],tdx.contentEditable=!0,tdy.contentEditable=!0,tdw.contentEditable=!0,tdh.contentEditable=!0,tdn.contentEditable=!0,tr.appendChild(tdi),tr.appendChild(tdx),tr.appendChild(tdy),tr.appendChild(tdw),tr.appendChild(tdh),tr.appendChild(tdn),tdx.onblur=function(event){let n=parseInt(event.currentTarget.innerText);var i=Array.from(edit.children).indexOf(event.currentTarget.parentNode);isFinite(n)||(n=cut.cuts[i][0]),cut.cuts[i][0]=n,event.currentTarget.innerText=n,draw()},tdy.onblur=function(event){let n=parseInt(event.currentTarget.innerText);var i=Array.from(edit.children).indexOf(event.currentTarget.parentNode);isFinite(n)||(n=cut.cuts[i][1]),cut.cuts[i][1]=n,event.currentTarget.innerText=n,draw()},tdw.onblur=function(event){let n=parseInt(event.currentTarget.innerText);var i=Array.from(edit.children).indexOf(event.currentTarget.parentNode);isFinite(n)||(n=cut.cuts[i][2]),cut.cuts[i][2]=n,event.currentTarget.innerText=n,draw()},tdh.onblur=function(event){let n=parseInt(event.currentTarget.innerText);var i=Array.from(edit.children).indexOf(event.currentTarget.parentNode);isFinite(n)||(n=cut.cuts[i][3]),cut.cuts[i][3]=n,event.currentTarget.innerText=n,draw()},tr.onclick=function(event){event.stopPropagation(),last_t&&last_t.classList.remove("ihover"),(last_t=event.currentTarget).classList.add("ihover"),draw()},tdx.f=tdy.f=tdw.f=tdh.f=tdn.f=!0,tdx.onkeydown=tdy.onkeydown=tdw.onkeydown=tdh.onkeydown=tdn.onkeydown=function(event){var t=event.currentTarget;switch(event.keyCode){case 37:event.preventDefault();var x=t.previousElementSibling;x&&(x.focus(),x.f=!0);break;case 38:{event.preventDefault();let x=t.parentNode;(x=x&&x.previousElementSibling)&&((x=x.children[Array.from(t.parentNode.children).indexOf(t)]).focus(),x.parentNode.click(),x.f=!0)}break;case 39:{event.preventDefault();const x=t.nextElementSibling;x&&(x.focus(),x.f=!0)}break;case 40:{event.preventDefault();let x=t.parentNode;(x=x&&x.nextElementSibling)&&((x=x.children[Array.from(t.parentNode.children).indexOf(t)]).focus(),x.parentNode.click(),x.f=!0)}break;case 13:event.preventDefault(),t.blur(),t.focus();break;case 8:t.textContent="";break;default:t.f&&(t.textContent="",t.f=!1)}},tr}function exportaimg(){var a;imgloaded&&((a=document.createElement("a")).href=img.src,a.click())}function exportcut(){var a=document.createElement("a"),idx=cutfile.lastIndexOf("/");a.download=-1==idx?cutfile:cutfile.slice(idx+1),a.href="data:text/plain;charset=utf-8,"+encodeURIComponent(`[imgcut]
0
${cut.name}
${cut.cuts.length}
${cut.cuts.map(x=>x.join(",")).join("\n")}
`),a.click()}function exportimga(){imgloaded&&!function download(i){var c=cut.cuts[i];c&&(preview.width=c[2],preview.height=c[3],pctx.clearRect(0,0,preview.width,preview.height),pctx.drawImage(img,c[0],c[1],c[2],c[3],0,0,c[2],c[3]),(c=document.createElement("a")).download=i+".png",c.href=preview.toDataURL(),c.click(),setTimeout(download,500,i+1))}(0)}function exportimg(){if(imgloaded){let i=0;var nodes=edit.getElementsByClassName("ihover"),nodes=(nodes.length&&(i=Array.from(edit.children).indexOf(nodes[0])),cut.cuts[i]),a=(preview.width=nodes[2],preview.height=nodes[3],pctx.clearRect(0,0,preview.width,preview.height),pctx.drawImage(img,nodes[0],nodes[1],nodes[2],nodes[3],0,0,nodes[2],nodes[3]),document.createElement("a"));a.download="cut "+i.toString()+(nodes[4]?` (${nodes[4]})`:""),a.href=preview.toDataURL(),a.click()}}function addline(){var c=[0,0,1,1,""],nodes=edit.getElementsByClassName("ihover");if(nodes.length){nodes=nodes[0];let idx=Array.from(edit.children).indexOf(nodes),n=(cut.cuts.splice(idx+1,0,c),nodes.after(createLine(c,idx+1)),nodes.nextElementSibling);for(;n.children[0].innerText=++idx,n=n.nextElementSibling;);last_t&&last_t.classList.remove("ihover"),void(last_t=nodes.nextElementSibling).classList.add("ihover")}else cut.cuts.push(c),last_t&&last_t.classList.remove("ihover"),(last_t=createLine(c,cut.cuts.length-1)).classList.add("ihover"),edit.appendChild(last_t)}function removeline(){if(edit.firstElementChild){let e,i;var nodes=edit.getElementsByClassName("ihover");i=nodes.length?(e=nodes[0],Array.from(edit.children).indexOf(e)):(e=edit.lastElementChild,edit.children.length-1),cut.cuts.splice(i,1);for(let n=e.nextElementSibling;n;n=n.nextElementSibling)n.children[0].innerText=i++;edit.removeChild(e)}}cut=new ImgCut,document.onclick=function(){last_t=null;for(var c of edit.getElementsByClassName("ihover"))c.classList.remove("ihover")};const file=document.getElementById("file");function importImg(){file.accept="image/*",file.onchange=function(){var f;this.files[0]&&((f=new FileReader).onload=function(e){img.src=e.target.result},f.readAsDataURL(this.files[0]),imgfile=this.files[0].name)},file.click()}function importImgU(){var u,url=prompt("圖片網址","/data/img015.png");url&&(img.src=url,imgfile=url,(u=new URL(location.href)).searchParams.set("imgfile",url),history.pushState({},"",u))}function importCut(){file.accept=".imgcut",file.onchange=function(){var f;this.files[0]&&((f=new FileReader).onload=function(e){cut=new ImgCut(e.target.result),edit.textContent="";for(let i=0;i<cut.cuts.length;++i)edit.appendChild(createLine(cut.cuts[i],i))},f.readAsText(this.files[0]),cutfile=this.files[0].name)},file.click()}function importCutU(){let url=prompt("ImgCut網址","/data/img015.imgcut");url&&fetch(url).then(res=>res.text()).then(text=>{cut=new ImgCut(text),edit.textContent="";for(let i=0;i<cut.cuts.length;++i)edit.appendChild(createLine(cut.cuts[i],i));cutfile=url;text=new URL(location.href);text.searchParams.set("cutfile",url),history.pushState({},"",text)})}async function pasteImg(){for(const c of await navigator.clipboard.read())for(const t of c.types.filter(x=>x.startsWith("image/"))){var blob=await c.getType(t),reader=new FileReader;return reader.onload=function(event){img.src=event.target.result,imgfile="clipboard"},void reader.readAsDataURL(blob)}}document.onpaste=function(event){var index,items=(event.clipboardData||event.originalEvent.clipboardData).items;for(index in items){var reader,item=items[index];if("file"===item.kind)return item=item.getAsFile(),(reader=new FileReader).onload=function(event){img.src=event.target.result,imgfile="clipboard"},void reader.readAsDataURL(item)}};const color=document.getElementById("color");function scolor(){ctx.strokeStyle=color.value,draw()}