var fs,info1,info2,info3,star,char_groups,stage_name="";const QQ="？？？",M1=document.getElementById("M1"),M2=document.getElementById("M2"),M3=document.getElementById("M3"),st1=document.getElementById("st-1").children,st2=document.getElementById("st-2").children,st3=document.getElementById("st-3").children,stName=document.getElementById("st-name"),stName2=document.getElementById("st-name2"),stLines=document.getElementById("lines"),main_div=document.getElementById("main"),search_result=document.getElementById("search-result"),m_drops=document.getElementById("drops"),rewards=document.getElementById("rewards"),m_times=document.getElementById("times"),mM=document.getElementById("mM"),ex_stages=document.getElementById("ex-stages"),stageL=parseInt(localStorage.getItem("stagel")||"0");var filter_page,Buffer=BrowserFS.BFSRequire("buffer").Buffer;const materialDrops=[85,86,87,88,89,90,91,140,187,188,189,190,191,192,193,194],treasures=(BrowserFS.install(window),[300,300,300,300,300,300,300,300,300,300,300,30,10,30,30,30,30,30,30,30,100,600,1500,300,100,30,300,300,300,300,100]);for(let e=0;e<31;++e){const b=localStorage.getItem("t$"+e.toString());null!=b&&(treasures[e]=parseInt(b))}function duo(e){return e<10?"0"+e.toString():e.toString()}const hidden_groups=[[25e3,25001,25003],[25007,25002,25004],[25008,25005,25006],[25009,25012,25015,25018,25021,25024,25027],[25010,25013,25016,25019,25022,25025,25028],[25011,25014,25017,25020,25023,25026,25029],[25063],[25064],[25065],[25030,25051,25052,25053],[25031,25054,25055,25056],[25032,25057,25058,25059],[25060],[25061],[25062],[25066]];function N(e){return e.name||e.jpname||QQ}function createReward(e,t){var n=document.createElement("td"),o=document.createElement("td"),a=new Image(128,128);if(a.style.maxWidth="2.7em",a.style.height="auto",o.appendChild(a),3!=t.length){var i=t[4],r=t3str(i),r=(t[3].endsWith("的權利")?a.src=`/img/u/${r}/s/uni${r}_s00.png`:a.src=`/img/u/${r}/f/uni${r}_f00.png`,document.createElement("a"));r.href="/unit.html?id="+i,r.textContent=t[3],r.style.verticalAlign="center",n.appendChild(r)}else{let e=t[1];i=document.createElement("span");i.style.verticalAlign="center",i.textContent=RWNAME[e]+(" ×"+t[2]),e<=13&&11<=e&&(e+=9),a.src=`/img/r/gatyaitemD_${duo(e)}_f.png`,n.appendChild(i)}e.appendChild(n),e.appendChild(o)}const mapConditions={10:{condition:[101017,-114024]},11:{condition:[101018,-114025]},12:{condition:[101019,-114026]},13:{condition:[101020,-114027]},14:{condition:[101021,-114028]},15:{condition:[101022,-114029]},16:{condition:[101023,-114030]},17:{condition:[101024,-114031]},18:{condition:[101025,-114032]},19:"通過狂亂貓咪降臨關卡(共9種)",21:"通過New Challenger4個",30:{condition:[101014,-114018]},31:{condition:[101015,-114019]},32:{condition:[101016,-114020]},33:{condition:[101039,-114021]},34:{condition:[101043,-114022]},35:{condition:[101066,-114023]},36:{condition:[101095,-114012]},37:{condition:[101117,-114013]},38:{condition:[101119,-114014]},39:{condition:[101128,-114015]},40:{condition:[101158,-114016]},41:{condition:[101177,-114017]},42:{condition:[101095,-201095]},43:{condition:[101117,-201117]},44:{condition:[101119,-201119]},45:{condition:[101128,-201128]},46:{condition:[101158,-201158]},47:{condition:[101177,-201177]},48:{condition:[101014,-201014]},49:{condition:[101015,-201015]},50:{condition:[101016,-201016]},51:{condition:[101039,-201039]},52:{condition:[101043,-201043]},53:{condition:[101066,-201066]},54:{condition:[101017,-201017]},55:{condition:[101018,-201018]},56:{condition:[101019,-201019]},57:{condition:[101020,-201020]},58:{condition:[101021,-201021]},59:{condition:[101022,-201022]},60:{condition:[101023,-201023]},61:{condition:[101024,-201024]},62:{condition:[101025,-201025]},63:"通過第4、第6、第9、第10使徒關卡",64:"通過”斷罪天使海蝶降臨”和”地獄門”",65:"通過”女帝飛來”和”亡者肥普降臨”",66:"通過”吉娃娃伯爵降臨”和”春宵苦短，少女做夢吧！”",67:{condition:[101257,101258,101266]},68:"通過時空的彎曲・解放的貓咪們2關卡",69:{condition:[107e3],stage:39},70:'通過魔界篇的"魔界火山"',71:"通過”藍色衝擊”和”亡者肥普降臨”",72:"通過”女帝飛來”和”春宵苦短，少女做夢吧！”",73:"通過”斷罪天使海蝶降臨”和”吉娃娃伯爵降臨”",74:{condition:[101215,-201215]},75:{condition:[101161,-201161]},76:{condition:[101096,-201096]},77:{condition:[101122,-201122]},78:{condition:[101189,-201189]},79:{condition:[101259,-201259]},80:{condition:[101226,-201226]},81:{condition:[101102,-201102]},82:{condition:[101103,-201103]},83:{condition:[101104,-201104]},84:{condition:[101105,-201105]},85:{condition:[101106,-201106]},86:{condition:[101107,-201107]},87:{condition:[101108,-201108]},88:{condition:[101109,-201109]},89:{condition:[101110,-201110]},90:{condition:[101157,-201157]},91:{condition:[101096,-114035]},92:{condition:[101122,-114036]},93:{condition:[101157,-114049]},94:{condition:[101189,-114037]},95:{condition:[101226,-114039]},96:{condition:[131e3],stage:3},97:{condition:[131001],stage:3},98:{condition:[131002],stage:3},99:{condition:[113047],stage:4},100:{condition:[131e3],stage:9},101:{condition:[131001],stage:9},102:{condition:[131002],stage:9},103:{condition:[101130,101131,101132,101133,101134,101135,101136,101137,101138]},104:{condition:[101259,-114038]},105:{condition:[131e3],stage:15},106:{condition:[131001],stage:15},107:{condition:[131002],stage:15},108:"通過”甲普拉密林”的所有關卡",109:"通過”亞蜥比沙漠”的所有關卡",110:"",0:"通過前一個關卡",1:"通過世界篇第1章",2:"通過世界篇第2章",3:"通過世界篇第3章",4:"通過未來篇第1章",5:"通過未來篇第2章",6:"通過未來篇第3章",7:"通過宇宙篇第1章",8:"通過宇宙篇第2章",9:"通過宇宙篇第3章",20:"通過所有的傳奇故事",25:"需要先達到等級排行1600以上",26:"通過3月・4月・5月活動3地圖",27:"通過6月・7月・8月活動3地圖",28:"通過9月・10月・11月活動3地圖",29:"通過12月・1月・2月活動3地圖",1e5:'通過"傳說的開始"全關卡',100001:'通過"熱情的國家"全關卡',100002:'通過"葡萄糖胺沙漠 "全關卡',100003:'通過"貓咪們渡海"全關卡',100004:'通過"凝視著貓眼石"全關卡',100005:'通過"西方街道"全關卡',100006:'通過"鮪魚海域"全關卡',100007:'通過"竹子島"全關卡',100008:'通過"黏糊糊的鐘乳洞"全關卡',100009:'通過"瓦魯肯諾火山"全關卡',100010:'通過"千里之道"全關卡',100011:'通過"鹹魚要塞"全關卡',100012:'通過"軍艦島"全關卡',100013:'通過"貓咪磨爪的走廊"全關卡',100014:'通過"帕德嫩神殿"全關卡',100015:'通過"退潮的海水浴場"全關卡',100016:'通過"惡魔島"全關卡',100017:'通過"越獄隧道"全關卡',100018:'通過"卡彭監獄"全關卡',100019:'通過"絲綢之路"全關卡',100020:'通過"通向黑暗的地下道"全關卡',100021:'通過"魔王的豪宅"全關卡',100022:'通過"終焉宣告之夜"全關卡',100023:'通過"大混戰"全關卡',100024:'通過"戰爭的傷痕"全關卡',100025:'通過"污染海洋的壞人"全關卡',100026:'通過"連接心身的東西"全關卡',100027:'通過"脆弱性和弱酸性"全關卡',100028:'通過"被引導的貓咪們"全關卡',100029:'通過"黑暗的國際城市"全關卡',100030:'通過"加拉・巴・哥"全關卡',100031:'通過"岩海苔半島"全關卡',100032:'通過"惡羅斯聯邦"全關卡',100033:'通過"亡者聚集之地"全關卡',100034:'通過"孤島大瘟疫"全關卡',100035:'通過"迪死你樂園"全關卡',100036:'通過"豪來塢帝國"全關卡',100037:'通過"小跟班海岸"全關卡',100038:'通過"雲泥溫泉鄉"全關卡',100039:'通過"濃濃春色島"全關卡',100040:'通過"IT地下墓穴"全關卡',100041:'通過"怪展會之畫"全關卡',100042:'通過"22區"全關卡',100043:'通過"超越大草原"全關卡',100044:'通過"暴風雪車道"全關卡',100045:'通過"奇點村"全關卡',100046:'通過"最終大陸"全關卡',100047:'通過"傳說的終點"全關卡',100048:'通過"古代研究所"全關卡',101009:"通過勞動感謝特別活動！",101010:"通過聖誕節居然來了！",101011:"通過新年快樂？",101012:"通過被召喚的福！",101013:"通過人偶架上的戰士們",101014:"通過紅色突變關卡",101026:"通過春天來了!高校教師",101029:"通過相思病戀歌",101030:"通過禁斷之妻",101031:"通過因為夏天喵！",101032:"通過返鄉熱潮！",101036:"通過在鎮上看到的超強老人",101038:"通過秋天運動會！",101196:"通過所有的絕・斷罪天使海蝶降臨關卡",101199:"通過絕・地獄門全關卡",101201:"通過絕・女帝飛來",101205:"通過絕・亡者肥普降臨",101207:"通過絕・吉娃娃伯爵降臨",101214:'通過"絕・春宵苦短，少女做夢吧！"全關卡',102035:"通過魔女之夜",113e3:"通過真・傳說的開始",101184:"通過新年快樂了？全關卡",101186:"通過再次被召喚的福！全關卡",101192:"通過人偶架上的戰士們特別版全關卡",101194:"通過新・春天來了!高校教師全關卡",101197:"通過再一次的相思病戀歌全關卡",101165:"通過續・禁斷之妻全關卡",101166:"通過因為超級夏天喵！全關卡",101167:"通過收假熱潮！全關卡",101168:"通過在鎮上看到的超強老人2全關卡",101170:"通過夜間運動會！全關卡",101171:"通過工作方式大革命全關卡",101175:"通過宇宙中聖誕節居然也來了！全關卡",101262:"通過熱血！兩人三腳賽 低學年",101263:"通過熱血！兩人三腳賽 中學年",101290:"通過後輩送的本命巧克力",101291:"通過前輩送的本命巧克力",999999:"目前的版本只能挑戰到這裡喵。等待下次的更新吧！",101312:"通過密林的異變",101313:"通過沙漠的怪事",101314:"通過火山的威脅",101315:"通過蟲蟲王者相撲 預賽",101316:"通過蟲蟲王者相撲 半準決賽",101317:"通過蟲蟲王者相撲 準決賽",101303:"通過Season4～畢業之日～",101300:"通過Weekend～告白～",101301:"通過Weekend～告白～",101302:"通過Weekend～告白～",101333:"通過密林的異變Ⅱ",101334:"通過沙漠的怪事Ⅱ",101335:"通過火山的威脅Ⅱ",101345:"通過密林的異變Ⅲ",101346:"通過沙漠的怪事Ⅲ",101347:"通過火山的威脅Ⅲ"};function numStr(e){return(Math.round(100*(e+Number.EPSILON))/100).toString()}function loadStage(){return new Promise(o=>{var e=indexedDB.open("stage",16);e.onupgradeneeded=function(e){e=e.target.result;try{e.deleteObjectStore("data")}catch(e){}e.createObjectStore("data",{keyPath:"name"}).createIndex("data","",{unique:!1})},e.onsuccess=function(e){const n=e.target.result;n.transaction("data").objectStore("data").get("stages").onsuccess=function(e){e=e.target.result;if(e)return o(e.data);fetch("/stages.zip").then(e=>e.arrayBuffer()).then(e=>{var t=n.transaction(["data"],"readwrite");t.objectStore("data").put({name:"stages",data:e}),t.oncomplete=function(){n.close()},o(e)})}}})}function search_reward(e){let i,r;filter_page.parentNode.style.display="none";var o=e.currentTarget.i;let d=document.createElement("table");search_result.textContent="",d.classList.add("w3-table","w3-centered","Co");e=document.createElement("tr");d.appendChild(e);let t=document.createElement("td");function a(e,t){var n=document.createElement("tr");let o=document.createElement("td");o.textContent=N(i),n.appendChild(o),o=document.createElement("td");var a=document.createElement("a");a.href="/stage.html?s="+t.join("-"),a.onclick=function(){return search_result.style.display="none",main_div.style.display="block",M1.selectedIndex=t[0],M1.oninput(null,t),!1},a.textContent=N(r),o.appendChild(a),n.appendChild(o),(o=document.createElement("td")).textContent=r.e,n.appendChild(o),createReward(n,e),d.appendChild(n)}t.textContent="地圖",e.appendChild(t),t=document.createElement("td"),e.appendChild(t),t.textContent="關卡",e.appendChild(t),(t=document.createElement("td")).textContent="統率力",e.appendChild(t),(t=document.createElement("td")).textContent="獎勵",e.appendChild(t),(t=document.createElement("td")).textContent="圖示",e.appendChild(t),search_result.appendChild(d),main_div.style.display="none",search_result.style.display="block";var s=fs.readdirSync("/stages");for(let n=0;n<s.length;++n){if("group"==(I=s[n]))return;var l=fs.readdirSync("/stages/"+I);for(let t=0;t<l.length;++t)if("info"!=(J=l[t])){var c=fs.readdirSync(`/stages/${I}/`+J);for(let e=0;e<c.length&&(K=c[e],i=null,"info"!=K);++e){if((r=JSON.parse(fs.readFileSync(`/stages/${I}/${J}/`+K))).drop)for(var p of r.drop)if(p[1]==o){i=i||JSON.parse(fs.readFileSync(`/stages/${I}/${J}/info`)),a(p,[n,t,e]);break}if(r.time)for(var m of r.time)if(m[1]==o){i=i||JSON.parse(fs.readFileSync(`/stages/${I}/${J}/info`)),a(m,[n,t,e]);break}}}}}function main(){var t=new URL(location.href),n=t.searchParams.get("q");if(n)doSearch({value:n}),document.getElementById("form").firstElementChild.value=n,history.pushState({},"","/stage.html");else{n=t.searchParams.get("star");(!n||(star=parseInt(n),isNaN(star))||star<=0||4<star)&&(star=1);let e=t.searchParams.get("s");if(e){n=e.split("-").map(e=>parseInt(e)).filter(e=>!isNaN(e));if(n.length)return M1.selectedIndex=n[0],M1.oninput(null,n),void(main_div.style.display="block")}else if(e=t.searchParams.get("v")){n=e.split("-").map(e=>parseInt(e)).filter(e=>!isNaN(e));if(n.length)return M1.value="/stages/"+n[0],M1.oninput(null,n),void(main_div.style.display="block")}M1.selectedIndex=0,M1.oninput(),main_div.style.display="block"}}function getConditionHTML(e){if(1e5<e){var t=Math.abs(e)%1e5;const l=~~(t/1e3),c=t%1e3;var t=JSON.parse(fs.readFileSync(`/stages/${l}/${c}/info`)),n=document.createElement("a");const o=document.createElement("div");return o.append("通過"),n.href=`/stage.html?v=${l}-`+c,n.textContent=N(t),n.onclick=function(e){return M1.value="/stages/"+l,M1.oninput(null,[null,c]),!1},o.appendChild(n),o}if(!(e=mapConditions[e]))return document.createTextNode(QQ);if("string"==typeof e)return document.createTextNode(e);if(e.hasOwnProperty("stage")){t=Math.abs(e.condition)%1e5;const p=~~(t/1e3),m=t%1e3;n=JSON.parse(fs.readFileSync(`/stages/${p}/${m}/info`)),t=document.createElement("a");const o=document.createElement("div"),u=(o.append("通過"),t.href=`/stage.html?${p}-`+m,e.stage);return t.textContent=N(n)+"第"+(u+1).toString()+"關",t.onclick=function(e){return M1.value="/stages/"+p,M1.oninput(null,[null,m,u]),!1},o.appendChild(t),o}const o=document.createElement("div");let a=0,i=0;for(const f of e.condition){var r=Math.abs(f),d=r%1e5;const h=~~(d/1e3),g=d%1e3;var d=JSON.parse(fs.readFileSync(`/stages/${h}/${g}/info`)),s=document.createElement("a");s.href=`/stage.html?v=${h}-`+g,s.textContent=N(d),s.onclick=function(e){return M1.value="/stages/"+h,M1.oninput(null,[null,g]),!1},a&&o.append(Math.sign(f)!=Math.sign(i)?"或":"及"),o.append(2e5<r?"通過":"玩過"),o.appendChild(s),++a,i=f}return o}function merge(t,n){if(group=[t[0],[...t[1]]],0==t[0]&&0==n[0]){group[1]=[];for(var e of t[1])n[1].includes(e)&&group[1].push(e)}else if(0==t[0]&&2==n[0])group[1]=group[1].filter(e=>n[1].contains(e));else if(2==t[0]&&0==n[0]){group[0]=0;for(var o of n[1])group[1].includes(o)||group[1].push(o);group[1]=group[1].filter(e=>t[1].contains(e))}else if(2==t[0]&&2==n[0])for(var a of n[1])group[1].includes(a)||group[1].push(a);return group}function getRarityString(t){var n=["基本","EX","稀有","激稀有","超激稀有","傳説稀有"],o=[];let a=0;for(let e=1;e<64;e<<=1)t&e&&o.push(n[a]),++a;return o.join("，")}loadStage().then(function(e){BrowserFS.configure({fs:"ZipFS",options:{zipData:Buffer.from(e)}},function(e){e?console.error(e):((fs=BrowserFS.BFSRequire("fs")).readdirSync("/stages").forEach(e=>{var t;"group"!=e&&(t=document.createElement("option"),e=JSON.parse(fs.readFileSync((t.value="/stages/"+e)+"/info")),t.textContent=e.name,M1.appendChild(t))}),char_groups=JSON.parse(fs.readFileSync("/stages/group")),main(),(e=document.getElementById("fs")).onclick=function(e){if(e.preventDefault(),e.stopPropagation(),"none"!=search_result.style.display&&(search_result.style.display="none"),"block"!=main_div.style.display&&(main_div.style.display="block"),!filter_page){var t;filter_page=(filter_page=document.getElementById("filter")).firstElementChild;for(t of[[0,1,2,3,4,5],[6,22,105,157,20,12,155,156],[196,195,185,186,163,178,198,14,15,137,162],[50,51,52,53,54,58],[55,56,57],[30,31,32,33,34,41,43,160,164],[35,36,37,38,39,42,40,161,44],[167,168,169,170,171,184],[179,180,181,182,183],[85,86,87,88,89,90,91,140]]){var n,o=document.createElement("div");o.classList.add("V");for(n of t){var a=new Image(128,128);a.classList.add("S"),a.src="https://battlecatsinfo.github.io/img/r/gatyaitemD_"+duo(n)+"_f.png",a.i=n,o.appendChild(a),a.onclick=search_reward}filter_page.appendChild(o)}}filter_page.parentNode.style.display="block"},document.onclick=function(e){filter_page&&(filter_page.parentNode.style.display="none")},(e=document.getElementById("prev")).onclick=function(){M3.selectedIndex?(--M3.selectedIndex,M3.oninput()):M2.selectedIndex?(--M2.selectedIndex,M2.oninput()):alert("沒有上一關了！")},e.nextElementSibling.onclick=function(){M3.selectedIndex+2<=M3.options.length?(M3.selectedIndex+=1,M3.oninput()):M2.selectedIndex+2<=M2.options.length?(M2.selectedIndex+=1,M2.oninput()):alert("沒有下一關了！")})})});class Limit{constructor(e){null!=e?(this.star=e[0],this.sid=e[1],this.rare=e[2],this.num=e[3],this.line=e[4],this.min=e[5],this.max=e[6],this.group=char_groups[e[7]]):(this.star=-1,this.sid=-1,this.rare=0,this.num=0,this.line=0,this.min=0,this.max=0)}combine(e){0==this.rare?this.rare=e.rare:0!=e.rare&&(this.rare&=e.rare),0<this.num*e.num?this.num=Math.min(this.num,e.num):this.num=Math.max(this.num,e.num),this.line|=e.line,this.min=Math.max(this.min,e.min),this.max=0<this.max&&0<e.max?Math.min(this.max,e.max):this.max+e.max,e.hasOwnProperty("group")&&(this.hasOwnProperty("group")?this.group=merge(this.group,e.group):this.group=e.group)}}function makeTd(e,t){var n=document.createElement("td");n.textContent=t,e.appendChild(n)}function t3str(e){var t=e.toString();switch(t.length){case 2:return"0"+t;case 1:return"00"+t}return t}function getDropData(){var e,t=[],n=0,o=info3.drop;for(e of o)n+=e[0];if(1e3==n)for(var a of o)t.push(numStr(a[0]/10));else if(n==o.length&&1!=n||-3==info3.rand){var i,r=Math.floor(100/o.length).toString();for(i of o)t.push(r)}else if(100==n)for(var d of o)t.push(d[0].toString());else if(100<n&&(0==info3.rand||1==info3.rand)){var s=100;if(100==o[0][0]){t.push("100");for(let e=1;e<o.length;++e){var l=s*o[e][0]/100;s-=l,t.push(numStr(l))}}else for(var c of o){c=s*c[0]/100;s-=c,t.push(numStr(c))}}else if(-4==info3.rand)for(var p of o)t.push(numStr(100*p[0]/n));else for(var m of o)t.push(m[0].toString());return t}function doSearch(e){const a=e.value.split(" ")[0];if(a){search_result.textContent="",main_div.style.display="none",search_result.style.display="block";var t=fs.readdirSync("/stages");let o=0;for(let n=0;n<t.length;++n){var i=t[n];if("group"!=i){var r=JSON.parse(fs.readFileSync(`/stages/${i}/info`)),d=fs.readdirSync("/stages/"+i);for(let t=0;t<d.length;++t){var s=d[t];if("info"!=s){var l=JSON.parse(fs.readFileSync(`/stages/${i}/${s}/info`));if((m(l.name)||m(l.jpname))&&(u([n,t],[r,l]),20<++o))return;var c=fs.readdirSync(`/stages/${i}/`+s);for(let e=0;e<c.length;++e){var p=c[e];if("info"!=p){p=JSON.parse(fs.readFileSync(`/stages/${i}/${s}/`+p));if((m(p.name)||m(p.jpname))&&(u([n,t,e],[r,l,p]),20<++o))return}}}}}}function m(e){return e&&e.includes(a)}function u(e,t){var n=document.createElement("a");for(let e=0;e<t.length;++e)t[e].name&&(t[e].name=t[e].name.replaceAll(a,e=>`<span>${e}</span>`)),t[e].jpname&&(t[e].jpname=t[e].jpname.replaceAll(a,e=>`<span>${e}</span>`));n.href="/stage.html?s="+e.join("-"),n.onclick=function(){return search_result.style.display="none",main_div.style.display="block",M1.selectedIndex=e[0],M1.oninput(null,e),!1},n.innerHTML=t.map(e=>e.name?e.jpname?`${e.name}(${e.jpname})`:e.name:e.jpname).join(" - "),n.classList.add("res"),search_result.appendChild(n)}o||(search_result.textContent="沒有結果")}else search_result.style.display="none",main_div.style.display="block"}M1.oninput=function(e,t){const n=M1.selectedOptions[0].value;info1=JSON.parse(fs.readFileSync(n+"/info")),M2.textContent="",M3.textContent="",fs.readdirSync(n).forEach(e=>{var t;"info"!=e&&(t=document.createElement("option"),e=JSON.parse(fs.readFileSync((t.value=n+"/"+e)+"/info")),t.textContent=stageL?1==stageL?e.jpname||QQ:[e.name,e.jpname].filter(e=>e).join("/"):N(e),M2.appendChild(t))}),t&&1<t.length?M2.selectedIndex=t[1]:M2.selectedIndex=0,M2.oninput(null,t)},M2.oninput=function(e,t){const n=M2.selectedOptions[0].value;info2=JSON.parse(fs.readFileSync(n+"/info")),M3.textContent="",fs.readdirSync(n).forEach(e=>{var t;"info"!=e&&(t=document.createElement("option"),e=JSON.parse(fs.readFileSync(t.value=n+"/"+e)),t.textContent=stageL?1==stageL?e.jpname||QQ:[e.name,e.jpname].filter(e=>e).join("/"):N(e),M3.appendChild(t))}),t&&2<t.length?M3.selectedIndex=t[2]:M3.selectedIndex=0,M3.oninput()},M3.oninput=function(){var t,n,o,J,a,e=M3.selectedOptions[0].value,i=new URL(location.href),e=(i.searchParams.set("s",[M1.selectedIndex,M2.selectedIndex,M3.selectedIndex].join("-")),star=info2.stars.length?Math.min(info2.stars.length,star):1,i.searchParams.set("star",star),history.pushState({},"",i),info3=JSON.parse(fs.readFileSync(e)),stName.textContent=stage_name=[info1.name||QQ,info2.name||QQ,info3.name||QQ].join(" - "),stName2.textContent=[info1.jpname||QQ,info2.jpname||QQ,info3.jpname||QQ].join(" - "),document.title=stage_name,document.getElementById("stars-tr")),e=(e&&e.parentNode.removeChild(e),document.getElementById("warn-tr")),e=(e&&e.parentNode.removeChild(e),document.getElementById("limit-bt"));e&&e.parentNode.removeChild(e);let r=info2.stars[star-1];if(r=r||100,info2.stars.length){var e=document.createElement("tr"),d=document.createElement("th");d.colSpan=6;for(let t=0;t<info2.stars.length;++t){const y=document.createElement("a");y.classList.add("star"),y.textContent=(t+1).toString()+"★: "+info2.stars[t].toString()+"%",i.searchParams.set("star",t+1),y.href=i.href,y.onclick=function(e){return star=t+1,M3.oninput(),!1},(star||t)&&star-1!=t||y.classList.add("W"),d.appendChild(y)}e.appendChild(d),e.id="stars-tr",stName.parentNode.parentNode.appendChild(e)}if((info3.hasOwnProperty("nC")||info2.rM||info1.hasOwnProperty("gc")||info2.hasOwnProperty("gc")||info2.hasOwnProperty("wT")||info2.hasOwnProperty("hC"))&&(e=document.createElement("tr"),C=document.createElement("th"),e.style.fontSize="larger",C.colSpan=6,info2.rM&&((g=document.createElement("div")).textContent=["過關獎勵將會在再次出現時重置","清除狀況將會在再次出現時重置","可過關次數將會在再次出現時重置"][info2.rM-1],g.classList.add("I"),C.appendChild(g)),info2.hasOwnProperty("wT")&&((g=document.createElement("div")).classList.add("W"),g.textContent="成功挑戰冷卻時長："+info2.wT.toString()+"分鐘",C.appendChild(g)),info2.hasOwnProperty("hC")&&((g=document.createElement("div")).classList.add("I"),g.textContent="全破後隱藏",C.appendChild(g)),(info1.hasOwnProperty("gc")||info2.hasOwnProperty("gc"))&&((g=document.createElement("div")).classList.add("W"),g.textContent="※掃蕩不可※",C.appendChild(g)),info3.hasOwnProperty("nC")&&((g=document.createElement("div")).classList.add("w"),g.textContent="※接關不可※",C.appendChild(g)),e.appendChild(C),e.id="warn-tr",stName.parentNode.parentNode.appendChild(e)),rewards.textContent="",info3.drop.length&&3!=M1.selectedIndex){var s,c,p,m,Q=getDropData();for(let e=0;e<info3.drop.length;++e)parseInt(Q[e])&&(s=info3.drop[e],c=document.createElement("tr"),p=document.createElement("td"),m=document.createElement("td"),p.appendChild(document.createTextNode(Q[e]+"%"+(0==e&&100!=s[0]&&-4!=info3.rand?" (寶雷)":""))),m.textContent=0==e&&(1==info3.rand||1e3<=info3.drop[0][1]&&info3.drop[0][1]<3e4)?"一次":"無",createReward(c,s),c.appendChild(p),c.appendChild(m),rewards.appendChild(c))}rewards.children.length?rewards.parentNode.style.display="table":rewards.parentNode.style.display="none",m_drops.textContent="";for(let e=1;e<info2.mD.length;++e)info2.mD[e]<=0||(t=new Image(128,128),a=materialDrops[e-1],t.style.maxWidth="2.7em",t.style.height="auto",t.src=`/img/r/gatyaitemD_${duo(a)}_f.png`,n=document.createElement("td"),o=document.createElement("tr"),(J=document.createElement("td")).textContent=RWNAME[a],o.appendChild(J),n.appendChild(t),o.appendChild(n),(a=document.createElement("td")).textContent=info2.mD[e]+"%",o.appendChild(a),m_drops.appendChild(o));if(m_drops.children.length?m_drops.parentNode.style.display="table":m_drops.parentNode.style.display="none",mM.textContent=`抽選次數: ${~~Math.round(info3.mM*info2.mP[star-1])}回`,info3.time){m_times.textContent="";for(var u of info3.time){var f=document.createElement("tr"),D=document.createElement("td"),R=document.createElement("td");D.textContent=u[2],R.textContent=u[0],createReward(f,u),f.appendChild(D),f.appendChild(R),m_times.appendChild(f)}m_times.parentNode.style.display="table"}else m_times.parentNode.style.display="none";st1[1].textContent="/stages/14"==M1.selectedOptions[0].value?"喵力達"+String.fromCharCode(65+info3.e/1e3)+"×"+(info3.e%1e3).toString():info3.e,st1[3].textContent=info3.max,st1[5].textContent=info3.len,info2.hasOwnProperty("mapcond")?(st3[3].textContent="",st3[3].appendChild(getConditionHTML(info2.mapcond))):st3[3].textContent="無限制",st2[1].textContent=info3.H;var h,g=document.createElement("a"),C=t3str(info3.castle%1e3),e=["rc","ec","wc","sc"][Math.floor(info3.castle/1e3)];g.href="/img/"+e+"/"+e+C+".png",g.textContent=C,st2[3].textContent="",st2[3].appendChild(g);const y=document.createElement("a");y.href="/img/bg/bg"+t3str(info3.bg)+".png",y.textContent=t3str(info3.bg),st2[5].textContent="",st2[5].appendChild(y),info2.hasOwnProperty("stagecond")?(st3[5].textContent="",st3[5].appendChild(getConditionHTML(info2.stagecond))):st3[5].textContent="無限制",info3.xp||3==M1.selectedIndex&&(info3.xp=1e3+300*Math.min(M3.selectedIndex,47));let W=info3.xp*(.95+.05*treasures[19]+.005*treasures[9]+.0025*treasures[10]);if([0,9,16].includes(M1.selectedIndex)&&(W*=9),st3[1].textContent=~~W,stLines.textContent="",info2.hasOwnProperty("Lim")){var e=info2.Lim.map(e=>new Limit(e)),A=star-1,x=new Limit,C=M3.selectedOptions[0].value,H=parseInt(C.slice(C.lastIndexOf("/")+1));for(l of e)-1!=l.star&&l.star!=A||-1!=l.sid&&l.sid!=H||x.combine(l);g=[];x.rare&&g.push("稀有度:"+getRarityString(x.rare)),x.num&&g.push("最多可出戰角色數量:"+x.num),x.max&&x.min?g.push(`生產成本${x.min}元與${x.max}元之間`):x.max?g.push(`生產成本${x.max}元以下`):x.min&&g.push(`生產成本${x.min}元以上`),x.line&&g.push("出陣列表:僅限第1頁"),x.group&&x.group[1].length&&g.push("可出擊角色的ID: "+x.group[1].join("/")),g.length&&(C=document.createElement("tr"),e=document.createElement("th"),(v=document.createElement("div")).textContent="※出擊限制※："+g.join("、"),v.classList.add("W"),C.style.fontSize="larger",e.colSpan=6,e.appendChild(v),C.appendChild(e),C.id="limit-bt",stName.parentNode.parentNode.appendChild(C))}if(ex_stages.textContent="",0<info3.eC){g=document.createElement("div");g.textContent="EX關卡(出現機率 "+info3.eC+"%)",ex_stages.appendChild(g);for(let e=info3.eI;e<=info3.eA;++e){var q=document.createElement("div"),z=JSON.parse(fs.readFileSync("/stages/4/"+info3.eM.toString()+"/"+e.toString()));const y=document.createElement("a");y.textContent=N(z),y.href="/stage.html?s=4-"+info3.eM.toString()+"-"+e.toString(),y.onclick=function(){return M1.value="/stages/4",M1.oninput(null,[null,info3.eM,e]),!1},q.appendChild(y),ex_stages.appendChild(q)}}else if(info3.hasOwnProperty("exS")){var v=document.createElement("table"),E=(v.classList.add("w3-table","w3-centered"),document.createElement("tbody")),e=document.createElement("tr"),C=document.createElement("td"),g=document.createElement("td");C.textContent="EX關卡",g.textContent="機率",e.appendChild(C),e.appendChild(g),E.appendChild(e);for(let e=0;e<info3.exS.length;++e){const T=info3.exS[e];var K=document.createElement("td"),X=document.createElement("td"),S=document.createElement("tr");const y=document.createElement("a");var M=T%100,I=~~(T%1e5/100),_=~~(T/1e5);const Y=[_,I,M];var U=JSON.parse(fs.readFileSync(`/stages/${_}/${I}/`+M));y.textContent=N(U),y.href=`/stage.html?v=${_}-${I}-`+M,y.onclick=function(e){return M1.value="/stages/"+Y[0],M1.oninput(null,Y),!1},K.appendChild(y),X.textContent=numStr(info3.exC[e])+"%",S.appendChild(K),S.appendChild(X),E.appendChild(S)}v.appendChild(E),ex_stages.appendChild(v)}else if(info3.hasOwnProperty("enc")){var C=document.createElement("table"),w=(C.classList.add("w3-table","w3-centered"),document.createElement("tbody")),g=document.createElement("tr"),e=document.createElement("td"),v=document.createElement("td");e.textContent="EX關卡",v.textContent="機率",g.appendChild(e),g.appendChild(v),w.appendChild(g);for(let e=0;e<info3.eni.length;++e){var b=document.createElement("td"),V=document.createElement("td"),$=document.createElement("tr"),O=(V.textContent=numStr(info3.enc[e])+"%",$.appendChild(b),$.appendChild(V),hidden_groups[info3.eni[e]]);for(let e=0;e<O.length;++e){const y=document.createElement("a");var k=~~(O[e]/1e3),Z=O[e]%1e3,G=JSON.parse(fs.readFileSync(`/stages/${k}/${Z}/info`));y.textContent=N(G);const ee=[k,Z];y.href=`/stage.html?v=${k}-`+Z,y.onclick=function(e){return M1.value="/stages/"+ee[0],M1.oninput(null,ee),!1},b.appendChild(y),e!=O.length-1&&b.appendChild(document.createTextNode(" or "))}w.appendChild($)}C.appendChild(w),ex_stages.appendChild(C)}ex_stages.children.length?ex_stages.style.display="block":ex_stages.style.display="none";for(h of info3.l){var B=document.createElement("tr"),L=h[0],j=(makeTd(B,enemy_names[L]||"?"),new Image(64,64));const y=document.createElement("a");var P=h[13]||100,F=h[9]||100,L=(y.href=`/enemy.html?id=${L}&mag=${F}&atkMag=${P}&stageMag=`+r,T=t3str(L),j.src="/img/e/"+T+"/enemy_icon_"+T+".png",document.createElement("td")),T=(L.style.padding="0px",y.appendChild(j),L.appendChild(y),B.appendChild(L),r/100),L=(makeTd(B,(F=Math.ceil(F*T).toString()+"%")==(P=Math.ceil(P*T).toString()+"%")?F:`HP:${F},ATK:`+P),makeTd(B,h[1]||"無限"),makeTd(B,100<h[5]?h[5]:h[5].toString()+"%"),h[3]>h[4]&&(j=h[3],h[3]=h[4],h[4]=j),Math.abs(h[2])>=Math.abs(h[10])?makeTd(B,h[2]):makeTd(B,h[2]+"~"+h[10]),makeTd(B,1==h[1]?"-":h[3]==h[4]?h[3]:h[3]+"~"+h[4]),makeTd(B,h[14]),h[8]);2==L?((T=document.createElement("span")).textContent="(BOSS,震波)",T.classList.add("boss"),B.firstElementChild.appendChild(T)):1==L&&((F=document.createElement("span")).textContent="(BOSS)",F.classList.add("boss"),B.firstElementChild.appendChild(F)),stLines.appendChild(B)}},document.getElementById("form").onsubmit=function(e){return e.preventDefault(),setTimeout(doSearch,0,e.currentTarget.firstElementChild),!1},window.onpopstate=()=>setTimeout(main,0);