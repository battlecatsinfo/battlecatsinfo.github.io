let loader=document.getElementById("loader"),stages_top=[["傳奇關卡","レジェンドストーリー"],["特別關卡","イベントステージ"],["期間限定合作關卡","コラボステージ"],["主篇章","日本編"],["EX關卡","EXステージ"],["貓咪道場關卡","ネコ道場",!0],["貓咪塔","風雲にゃんこ塔"],["排行關卡","ネコ道場ランキング",!0],["挑戰賽","チャレンジバトル",!0],["真傳奇關卡","真レジェンドステージ"],["喵力達專用關卡","ネコビタンステージ"],["強襲關卡","強襲ステージ"],["發掘關卡","発掘ステージ"],["合作強襲","コラボ強襲ステージ"],["超獸討伐關卡","超獣研究ステージ"],["地底迷宮","地底迷宮",!0],["傳奇故事0","レジェンドストーリー0"],["異次元競技場","異次元コロシアム"]],eggs=new Set([656,658,659,663,664,665,669,670,675,676,685,691,697,700,706,707,713,716,717,720,724,730,757]),MC_TW_NAME=0,MC_JP_NAME=1,MC_GOLDCPU=2,SI_TW_NAME=0,SI_JP_NAME=1,SI_XP=2,SI_HEALTH=3,SI_ENERGY=4,SI_LEN=5,SI_RAND=6,SI_DROP=7,SI_TIME=8,SI_MAXMATERIAL=9,SI_FLAGS=10,SI_MAX=11,SI_MIN_SPAWN=12,SI_BG=13,SI_ENEMY_LINES=14,SI_EX_STAGE=15,SM_TW_NAME=0,SM_JP_NAME=1,SM_STARS=2,SM_MAPCOND=3,SM_STAGECOND=4,SM_MATERIALDROP=5,SM_MULTIPLIER=6,SM_FLAGS=7,SM_WAITFORTIMER=8,SM_RESETMODE=9,SM_SPECIALCOND=10,SM_INVALID_COMBO=11,SM_LIMIT=12,QQ="？？？",mapConditions={10:{condition:[101017,-114024]},11:{condition:[101018,-114025]},12:{condition:[101019,-114026]},13:{condition:[101020,-114027]},14:{condition:[101021,-114028]},15:{condition:[101022,-114029]},16:{condition:[101023,-114030]},17:{condition:[101024,-114031]},18:{condition:[101025,-114032]},19:"通過狂亂貓咪降臨關卡(共9種)",21:"通過New Challenger4個",30:{condition:[101014,-114018]},31:{condition:[101015,-114019]},32:{condition:[101016,-114020]},33:{condition:[101039,-114021]},34:{condition:[101043,-114022]},35:{condition:[101066,-114023]},36:{condition:[101095,-114012]},37:{condition:[101117,-114013]},38:{condition:[101119,-114014]},39:{condition:[101128,-114015]},40:{condition:[101158,-114016]},41:{condition:[101177,-114017]},42:{condition:[101095,-201095]},43:{condition:[101117,-201117]},44:{condition:[101119,-201119]},45:{condition:[101128,-201128]},46:{condition:[101158,-201158]},47:{condition:[101177,-201177]},48:{condition:[101014,-201014]},49:{condition:[101015,-201015]},50:{condition:[101016,-201016]},51:{condition:[101039,-201039]},52:{condition:[101043,-201043]},53:{condition:[101066,-201066]},54:{condition:[101017,-201017]},55:{condition:[101018,-201018]},56:{condition:[101019,-201019]},57:{condition:[101020,-201020]},58:{condition:[101021,-201021]},59:{condition:[101022,-201022]},60:{condition:[101023,-201023]},61:{condition:[101024,-201024]},62:{condition:[101025,-201025]},63:"通過第4、第6、第9、第10使徒關卡",64:"通過”斷罪天使海蝶降臨”和”地獄門”",65:"通過”女帝飛來”和”亡者肥普降臨”",66:"通過”吉娃娃伯爵降臨”和”春宵苦短，少女做夢吧！”",67:{condition:[101257,101258,101266]},68:"通過時空的彎曲・解放的貓咪們2關卡",69:{condition:[107e3],stage:39},70:'通過魔界篇的"魔界火山"',71:"通過”藍色衝擊”和”亡者肥普降臨”",72:"通過”女帝飛來”和”春宵苦短，少女做夢吧！”",73:"通過”斷罪天使海蝶降臨”和”吉娃娃伯爵降臨”",74:{condition:[101215,-201215]},75:{condition:[101161,-201161]},76:{condition:[101096,-201096]},77:{condition:[101122,-201122]},78:{condition:[101189,-201189]},79:{condition:[101259,-201259]},80:{condition:[101226,-201226]},81:{condition:[101102,-201102]},82:{condition:[101103,-201103]},83:{condition:[101104,-201104]},84:{condition:[101105,-201105]},85:{condition:[101106,-201106]},86:{condition:[101107,-201107]},87:{condition:[101108,-201108]},88:{condition:[101109,-201109]},89:{condition:[101110,-201110]},90:{condition:[101157,-201157]},91:{condition:[101096,-114035]},92:{condition:[101122,-114036]},93:{condition:[101157,-114049]},94:{condition:[101189,-114037]},95:{condition:[101226,-114039]},96:{condition:[131e3],stage:3},97:{condition:[131001],stage:3},98:{condition:[131002],stage:3},99:{condition:[113047],stage:4},100:{condition:[131e3],stage:9},101:{condition:[131001],stage:9},102:{condition:[131002],stage:9},103:{condition:[101130,101131,101132,101133,101134,101135,101136,101137,101138]},104:{condition:[101259,-114038]},105:{condition:[131e3],stage:15},106:{condition:[131001],stage:15},107:{condition:[131002],stage:15},108:"通過”甲普拉密林”的所有關卡",109:"通過”亞蜥比沙漠”的所有關卡",110:"",111:"",112:{condition:[101350,101351,101352,101353,101354,101355,101356,101357,101358]},113:{condition:[101217,101232]},114:{condition:[101229,101231]},115:{condition:[101219,101220]},116:{condition:[101199,101214]},117:{condition:[101207,101196]},118:{condition:[101201,101205]},0:"通過前一個關卡",1:"通過世界篇第1章",2:"通過世界篇第2章",3:"通過世界篇第3章",4:"通過未來篇第1章",5:"通過未來篇第2章",6:"通過未來篇第3章",7:"通過宇宙篇第1章",8:"通過宇宙篇第2章",9:"通過宇宙篇第3章",20:"通過所有的傳奇故事",25:"需要先達到等級排行1600以上",26:"通過3月・4月・5月活動3地圖",27:"通過6月・7月・8月活動3地圖",28:"通過9月・10月・11月活動3地圖",29:"通過12月・1月・2月活動3地圖",1e5:'通過"傳說的開始"全關卡',100001:'通過"熱情的國家"全關卡',100002:'通過"葡萄糖胺沙漠 "全關卡',100003:'通過"貓咪們渡海"全關卡',100004:'通過"凝視著貓眼石"全關卡',100005:'通過"西方街道"全關卡',100006:'通過"鮪魚海域"全關卡',100007:'通過"竹子島"全關卡',100008:'通過"黏糊糊的鐘乳洞"全關卡',100009:'通過"瓦魯肯諾火山"全關卡',100010:'通過"千里之道"全關卡',100011:'通過"鹹魚要塞"全關卡',100012:'通過"軍艦島"全關卡',100013:'通過"貓咪磨爪的走廊"全關卡',100014:'通過"帕德嫩神殿"全關卡',100015:'通過"退潮的海水浴場"全關卡',100016:'通過"惡魔島"全關卡',100017:'通過"越獄隧道"全關卡',100018:'通過"卡彭監獄"全關卡',100019:'通過"絲綢之路"全關卡',100020:'通過"通向黑暗的地下道"全關卡',100021:'通過"魔王的豪宅"全關卡',100022:'通過"終焉宣告之夜"全關卡',100023:'通過"大混戰"全關卡',100024:'通過"戰爭的傷痕"全關卡',100025:'通過"污染海洋的壞人"全關卡',100026:'通過"連接心身的東西"全關卡',100027:'通過"脆弱性和弱酸性"全關卡',100028:'通過"被引導的貓咪們"全關卡',100029:'通過"黑暗的國際城市"全關卡',100030:'通過"加拉・巴・哥"全關卡',100031:'通過"岩海苔半島"全關卡',100032:'通過"惡羅斯聯邦"全關卡',100033:'通過"亡者聚集之地"全關卡',100034:'通過"孤島大瘟疫"全關卡',100035:'通過"迪死你樂園"全關卡',100036:'通過"豪來塢帝國"全關卡',100037:'通過"小跟班海岸"全關卡',100038:'通過"雲泥溫泉鄉"全關卡',100039:'通過"濃濃春色島"全關卡',100040:'通過"IT地下墓穴"全關卡',100041:'通過"怪展會之畫"全關卡',100042:'通過"22區"全關卡',100043:'通過"超越大草原"全關卡',100044:'通過"暴風雪車道"全關卡',100045:'通過"奇點村"全關卡',100046:'通過"最終大陸"全關卡',100047:'通過"傳說的終點"全關卡',100048:'通過"古代研究所"全關卡',101009:"通過勞動感謝特別活動！",101010:"通過聖誕節居然來了！",101011:"通過新年快樂？",101012:"通過被召喚的福！",101013:"通過人偶架上的戰士們",101014:"通過紅色突變關卡",101026:"通過春天來了!高校教師",101029:"通過相思病戀歌",101030:"通過禁斷之妻",101031:"通過因為夏天喵！",101032:"通過返鄉熱潮！",101036:"通過在鎮上看到的超強老人",101038:"通過秋天運動會！",101196:"通過所有的絕・斷罪天使海蝶降臨關卡",101199:"通過絕・地獄門全關卡",101201:"通過絕・女帝飛來",101205:"通過絕・亡者肥普降臨",101207:"通過絕・吉娃娃伯爵降臨",101214:'通過"絕・春宵苦短，少女做夢吧！"全關卡',102035:"通過魔女之夜",113e3:"通過真・傳說的開始",101184:"通過新年快樂了？全關卡",101186:"通過再次被召喚的福！全關卡",101192:"通過人偶架上的戰士們特別版全關卡",101194:"通過新・春天來了!高校教師全關卡",101197:"通過再一次的相思病戀歌全關卡",101165:"通過續・禁斷之妻全關卡",101166:"通過因為超級夏天喵！全關卡",101167:"通過收假熱潮！全關卡",101168:"通過在鎮上看到的超強老人2全關卡",101170:"通過夜間運動會！全關卡",101171:"通過工作方式大革命全關卡",101175:"通過宇宙中聖誕節居然也來了！全關卡",101262:"通過熱血！兩人三腳賽 低學年",101263:"通過熱血！兩人三腳賽 中學年",101290:"通過後輩送的本命巧克力",101291:"通過前輩送的本命巧克力",999999:"目前的版本只能挑戰到這裡喵。等待下次的更新吧！",101312:"通過密林的異變",101313:"通過沙漠的怪事",101314:"通過火山的威脅",101315:"通過蟲蟲王者相撲 預賽",101316:"通過蟲蟲王者相撲 半準決賽",101317:"通過蟲蟲王者相撲 準決賽",101303:"通過Season4～畢業之日～",101300:"通過Weekend～告白～",101301:"通過Weekend～告白～",101302:"通過Weekend～告白～",101333:"通過密林的異變Ⅱ",101334:"通過沙漠的怪事Ⅱ",101335:"通過火山的威脅Ⅱ",101345:"通過密林的異變Ⅲ",101346:"通過沙漠的怪事Ⅲ",101347:"通過火山的威脅Ⅲ",102210:"通過週末演唱會 第1天"},M1=document.getElementById("M1"),M2=document.getElementById("M2"),M3=document.getElementById("M3"),st1=document.getElementById("st-1").children,st2=document.getElementById("st-2").children,st3=document.getElementById("st-3").children,stName=document.getElementById("st-name"),stName2=document.getElementById("st-name2"),stLines=document.getElementById("lines"),main_div=document.getElementById("main"),search_result=document.getElementById("search-result"),m_drops=document.getElementById("drops"),rewards=document.getElementById("rewards"),m_times=document.getElementById("times"),mM=document.getElementById("mM"),ex_stages=document.getElementById("ex-stages"),stageL=parseInt(localStorage.getItem("stagel")||"0",10),materialDrops=[85,86,87,88,89,90,91,140,187,188,189,190,191,192,193,194];var db,info1,info2,info3,star,char_groups,filter_page,stageF;function duo(e){return e<10?"0"+e.toString():e.toString()}function fromV(e){switch(e){case 0:case 1:case 3:case 2:return e;case 4:return 4;case 6:return 5;case 7:return 6;case 11:return 7;case 12:return 8;case 13:return 9;case 14:return 10;case 24:return 11;case 25:return 12;case 27:return 13;case 31:return 14;case 33:return 15;case 34:return 16;case 36:return 17;default:return 1}}function namefor(e){var t=e.indexOf("\t"),n=e.slice(0,t);return n||e.slice(t+=1,e.indexOf("\t",t))||QQ}function createReward(e,t){var n,a,o=document.createElement("td"),i=document.createElement("td"),s=new Image(128,128);s.style.maxWidth="2.7em",s.style.height="auto",i.appendChild(s),3!=t.length?(n=t[4],t[3].endsWith("的權利")?s.src=`/img/u/${n}/s/uni${n}_s00.png`:eggs.has(parseInt(n))?s.src="/img/s/000/uni000_m01.png":s.src=`/img/u/${n}/f/uni${n}_f00.png`,(a=document.createElement("a")).href="/unit.html?id="+n,a.textContent=t[3],a.style.verticalAlign="center",o.appendChild(a)):(n=parseInt(t[1],10),(a=document.createElement("span")).style.verticalAlign="center",a.textContent=RWNAME[n]+" ×".concat(t[2]),n<=13&&11<=n&&(n+=9),s.src="/img/r/gatyaitemD_".concat(duo(n),"_f.png"),o.appendChild(a)),e.appendChild(o),e.appendChild(i)}function numStr(e){return(Math.round(100*(e+Number.EPSILON))/100).toString()}function TI(e){return stageF?stageF.format(e/30)+"s":e.toString()}function TI2(e){return stageF?stageF.format(parseInt(e,10)/30)+"s":e}function search_guard(){filter_page.parentNode.style.display="none",main_div.style.display="none",search_result.textContent="",search_result.style.display="block";let l=document.createElement("table");l.classList.add("w3-table","w3-centered","Co");var e=document.createElement("tr");l.appendChild(e);let t=document.createElement("td");t.textContent="地圖",e.appendChild(t),(t=document.createElement("td")).textContent="關卡",e.appendChild(t),search_result.appendChild(l),l.classList.add("w3-table","w3-centered","Co"),db.transaction("stage").objectStore("stage").openCursor().onsuccess=function(n){if(n=n.target.result){var a=n.value.split("\t");if(2&parseInt(a[SI_FLAGS],36)){var o=document.createElement("tr");let e=document.createElement("td"),t=document.createElement("a");db.transaction("map").objectStore("map").get(~~(n.key/1e3)).onsuccess=function(e){t.textContent=namefor(e.target.result)};var i=~~(n.key/1e6),s=n.key%1e3,r=~~((n.key-1e6*i)/1e3),d=[i,r,s],i=(t.href=`/stage.html?s=${i}-`+r,e.appendChild(t),o.appendChild(e),e=document.createElement("td"),document.createElement("a"));i.textContent=a[SI_TW_NAME]||a[SI_JP_NAME],i.href=t.href+"-"+s,i.sts=d,t.sts=d,t.onclick=function(){return search_result.style.display="none",main_div.style.display="block",M1.oninput(null,this.sts.slice(0,2)),!1},i.onclick=function(){return search_result.style.display="none",main_div.style.display="block",M1.oninput(null,this.sts),!1},e.appendChild(i),o.appendChild(e),l.appendChild(o)}n.continue()}}}function search_demon(){filter_page.parentNode.style.display="none",main_div.style.display="none",search_result.textContent="",search_result.style.display="block";let l=document.createElement("table");l.classList.add("w3-table","w3-centered","Co");var e=document.createElement("tr");l.appendChild(e);let t=document.createElement("td");t.textContent="地圖",e.appendChild(t),(t=document.createElement("td")).textContent="關卡",e.appendChild(t),search_result.appendChild(l),l.classList.add("w3-table","w3-centered","Co"),db.transaction("stage").objectStore("stage").openCursor().onsuccess=function(n){if(n=n.target.result){var a=n.value.split("\t");if(a[SI_ENEMY_LINES].startsWith("fy")){var o=document.createElement("tr");let e=document.createElement("td"),t=document.createElement("a");db.transaction("map").objectStore("map").get(~~(n.key/1e3)).onsuccess=function(e){t.textContent=namefor(e.target.result)};var i=~~(n.key/1e6),s=n.key%1e3,r=~~((n.key-1e6*i)/1e3),d=[i,r,s],i=(t.href=`/stage.html?s=${i}-`+r,e.appendChild(t),o.appendChild(e),e=document.createElement("td"),document.createElement("a"));i.textContent=a[SI_TW_NAME]||a[SI_JP_NAME],i.href=t.href+"-"+s,i.sts=d,t.sts=d,t.onclick=function(){return search_result.style.display="none",main_div.style.display="block",M1.oninput(null,this.sts.slice(0,2)),!1},i.onclick=function(){return search_result.style.display="none",main_div.style.display="block",M1.oninput(null,this.sts),!1},e.appendChild(i),o.appendChild(e),l.appendChild(o)}n.continue()}}}function search_gold(){filter_page.parentNode.style.display="none",main_div.style.display="none",search_result.textContent="",search_result.style.display="block";let d=document.createElement("table"),t=(d.classList.add("w3-table","w3-centered","Co"),document.createElement("tr")),n=(d.appendChild(t),document.createElement("td"));n.textContent="分類",t.appendChild(n),n=document.createElement("td"),t.appendChild(n),n.textContent="地圖",t.appendChild(n),search_result.appendChild(d),d.classList.add("w3-table","w3-centered","Co");for(let e=0;e<stages_top.length;++e){var a;stages_top[e][MC_GOLDCPU]&&(t=document.createElement("tr"),n=document.createElement("td"),(a=document.createElement("a")).textContent=stages_top[e][MC_TW_NAME],a.href="/stage.html?s="+e,a.onclick=function(){return search_result.style.display="none",main_div.style.display="block",M1.selectedIndex=e,M1.oninput(null),!1},n.appendChild(a),t.appendChild(n),(n=document.createElement("td")).textContent="<全地圖皆不可掃蕩>",t.appendChild(n),d.appendChild(t))}db.transaction("map").objectStore("map").openCursor(IDBKeyRange.lowerBound(0)).onsuccess=function(t){if(t=t.target.result){var n=t.value.split("\t");if(2&parseInt(n[SM_FLAGS],36)){var a=document.createElement("tr");let e=document.createElement("td");var o=document.createElement("a"),i=~~(t.key/1e3),s=t.key%1e3,r=(o.textContent=stages_top[i][MC_TW_NAME],o.href="/stage.html?s="+i,e.appendChild(o),a.appendChild(e),e=document.createElement("td"),document.createElement("a"));r.textContent=n[SI_TW_NAME]||n[SI_JP_NAME],r.href=o.href+"-"+s,r.sts=[i,s],o.v=i,o.onclick=function(){return search_result.style.display="none",main_div.style.display="block",M1.selectedIndex=this.v,M1.oninput(null),!1},r.onclick=function(){return search_result.style.display="none",main_div.style.display="block",M1.oninput(null,this.sts),!1},e.appendChild(r),a.appendChild(e),d.appendChild(a)}t.continue()}}}function search_reward(e){let t=e.currentTarget.i.toString(),p=RWNAME[e.currentTarget.i],u=(filter_page.parentNode.style.display="none",main_div.style.display="none",search_result.textContent="",search_result.style.display="block",document.createElement("table"));u.classList.add("w3-table","w3-centered","Co");e=document.createElement("tr");u.appendChild(e);let n=document.createElement("td");n.textContent="地圖",e.appendChild(n),(n=document.createElement("td")).textContent="關卡",e.appendChild(n),(n=document.createElement("td")).textContent="統率力",e.appendChild(n),(n=document.createElement("td")).textContent="掉落",e.appendChild(n),search_result.appendChild(u),u.classList.add("w3-table","w3-centered","Co"),db.transaction("stage").objectStore("stage").openCursor().onsuccess=function(n){if(n=n.target.result){var a=n.value.split("\t"),e=a[SI_DROP];if(e)for(var o of e.split("|")){var i=o.indexOf(",")+1,s=o.indexOf(",",i);if(o.slice(i,s)==t){i=document.createElement("tr");let t=document.createElement("td");db.transaction("map").objectStore("map").get(~~(n.key/1e3)).onsuccess=function(e){t.textContent=namefor(e.target.result)};var r=~~(n.key/1e6),d=n.key%1e3,l=~~((n.key-1e6*r)/1e3);i.appendChild(t);let e=document.createElement("td");var c=document.createElement("a");c.textContent=a[SI_TW_NAME]||a[SI_JP_NAME],c.href=`/stage.html?s=${r}-${l}-`+d,c.sts=[r,l,d],c.onclick=function(){return search_result.style.display="none",main_div.style.display="block",M1.oninput(null,this.sts),!1},e.appendChild(c),i.appendChild(e),(e=document.createElement("td")).textContent=parseInt(a[SI_ENERGY],36),i.appendChild(e),u.appendChild(i),(e=document.createElement("td")).textContent=p+" ×"+o.slice(s+1),i.appendChild(e),u.appendChild(i);break}}n.continue()}}}function initUI(){var e,t;for(t of stages_top)(e=document.createElement("option")).textContent=t[0],M1.appendChild(e);document.getElementById("fs").onclick=function(e){if(e.preventDefault(),e.stopPropagation(),search_result.style.display="none",search_result.textContent="","block"!=main_div.style.display&&(main_div.style.display="block"),!filter_page){filter_page=document.getElementById("filter").firstElementChild;var t=["4rrfKiE","Rfuh0jk","JWSKik7"],n=[search_guard,search_demon,search_gold],a=[66,65,64,64,80,80],o=void 0;(d=document.createElement("div")).classList.add("V");for(var i=0;i<t.length;++i)(o=new Image(a[i+i],a[i+i+1])).classList.add("S"),o.src="https://i.imgur.com/".concat(t[i],".png"),d.appendChild(o),o.onclick=n[i];filter_page.appendChild(d);for(var s=0,r=[[0,1,2,3,4,5,55,56,57],[22,6,105,157,20,21,155,156],[203,202,185,200,163,178,198,24,25,137,162],[50,51,52,53,54,58],[30,31,32,33,34,41,43,160,164],[35,36,37,38,39,42,40,161,44],[167,168,169,170,171,184],[179,180,181,182,183],[85,86,87,88,89,90,91,140]];s<r.length;s++){var d,l=r[s];(d=document.createElement("div")).classList.add("V");for(var c=0,p=l;c<p.length;c++){var u=p[c];(o=new Image(128,128)).classList.add("S"),o.src="/img/r/gatyaitemD_"+duo(u)+"_f.png",o.i=20<=u&&u<=22?u-9:u,d.appendChild(o),o.onclick=search_reward}filter_page.appendChild(d)}}filter_page.parentNode.style.display="block"},document.onclick=function(){filter_page&&(filter_page.parentNode.style.display="none")};var n=document.getElementById("prev");n.onclick=function(){M3.selectedIndex?(--M3.selectedIndex,M3.oninput()):M2.selectedIndex?(--M2.selectedIndex,M2.oninput()):alert("沒有上一關了！")},n.nextElementSibling.onclick=function(){M3.selectedIndex+2<=M3.options.length?(M3.selectedIndex+=1,M3.oninput()):M2.selectedIndex+2<=M2.options.length?(M2.selectedIndex+=1,M2.oninput()):alert("沒有下一關了！")},handle_url()}function handle_url(){var n=new URL(location.href),a=n.searchParams.get("q");if(a)loader.style.display="none",loader.previousSibling.style.display="none",doSearch({value:a}),document.getElementById("form").firstElementChild.value=a;else{a=n.searchParams.get("star");(!a||(star=parseInt(a,10),isNaN(star))||star<=0||4<star)&&(star=1);let e,t=n.searchParams.get("s");t?e=t.split("-").map(e=>parseInt(e,10)):(t=n.searchParams.get("v"))&&((e=t.split("-").map(e=>parseInt(e,10)))[0]=fromV(e[0])),M1.oninput(null,e),loader.style.display="none",loader.previousSibling.style.display="none",main_div.style.display="block"}}function getConditionHTML(n){if(1e5<(n=parseInt(n,36))){var a=Math.abs(n)%1e5,o=fromV(~~(a/1e3)),a=a%1e3;let t=document.createElement("a"),e=document.createElement("div");return db.transaction("map").objectStore("map").get(1e3*o+a).onsuccess=function(e){t.textContent=namefor(e.target.result)},e.append("通過"),t.href=`/stage.html?s=${o}-`+a,t.s=[o,a],t.onclick=function(e){return M1.oninput(null,this.s),!1},e.appendChild(t),e}if(!(n=mapConditions[n]))return document.createTextNode(QQ);if("string"==typeof n)return document.createTextNode(n);if(n.hasOwnProperty("stage")){o=Math.abs(n.condition)%1e5,a=fromV(~~(o/1e3)),o=o%1e3;let t=document.createElement("a"),e=document.createElement("div");e.append("通過"),db.transaction("map").objectStore("map").get(1e3*a+o).onsuccess=function(e){t.textContent=namefor(e.target.result)+t.n},t.href=`/stage.html?${a}-`+o;var i=n.stage;return t.n="第"+(i+1).toString()+"關",t.s=[a,o,i],t.onclick=function(e){return M1.oninput(null,this.s),!1},e.appendChild(t),e}let e=document.createElement("div"),s=0,r=0;for(var d of n.condition){var l=Math.abs(d),c=l%1e5,p=fromV(~~(c/1e3)),c=c%1e3;let t=document.createElement("a");t.href=`/stage.html?v=${p}-`+c,db.transaction("map").objectStore("map").get(1e3*p+c).onsuccess=function(e){t.textContent=namefor(e.target.result)},t.s=[p,c],t.onclick=function(e){return M1.oninput(null,this.s),!1},s&&e.append(Math.sign(d)!=Math.sign(r)?"或":"及"),e.append(2e5<l?"通過":"玩過"),e.appendChild(t),++s,r=d}return e}function merge(t,n){var e=[t[0],[...t[1]]];if(0==t[0]&&0==n[0]){e[1]=[];for(var a=0,o=t[1];a<o.length;a++){var i=o[a];n[1].includes(i)&&e[1].push(i)}}else if(0==t[0]&&2==n[0])e[1]=e[1].filter(function(e){return n[1].includes(e)});else if(2==t[0]&&0==n[0]){for(var s=e[0]=0,r=n[1];s<r.length;s++){i=r[s];e[1].includes(i)||e[1].push(i)}e[1]=e[1].filter(function(e){return t[1].includes(e)})}else if(2==t[0]&&2==n[0])for(var d=0,l=n[1];d<l.length;d++){i=l[d];e[1].includes(i)||e[1].push(i)}return e}function getRarityString(e){for(var t=["基本","EX","稀有","激稀有","超激稀有","傳説稀有"],n=[],a=0,o=1;o<64;o<<=1)e&o&&n.push(t[a]),++a;return n.join("，")}"s"==localStorage.getItem("stagef")&&(stageF=new Intl.NumberFormat(void 0,{maximumFractionDigits:2}));class Limit{constructor(e){null!=e?(e=e.split(","),this.star=parseInt(e[0],10),this.sid=parseInt(e[1],10),this.rare=parseInt(e[2],10),this.num=parseInt(e[3],10),this.line=parseInt(e[4],10),this.min=parseInt(e[5],10),this.max=parseInt(e[6],10),this.group=char_groups[parseInt(e[7],10)]):(this.star=-1,this.sid=-1,this.rare=0,this.num=0,this.line=0,this.min=0,this.max=0)}combine(e){0==this.rare?this.rare=e.rare:0!=e.rare&&(this.rare&=e.rare),0<this.num*e.num?this.num=Math.min(this.num,e.num):this.num=Math.max(this.num,e.num),this.line|=e.line,this.min=Math.max(this.min,e.min),this.max=0<this.max&&0<e.max?Math.min(this.max,e.max):this.max+e.max,e.hasOwnProperty("group")&&(this.hasOwnProperty("group")?this.group=merge(this.group,e.group):this.group=e.group)}}function process_2(){var e=1e6*M1.selectedIndex+1e3*M2.selectedIndex;db.transaction("stage").objectStore("stage").openCursor(IDBKeyRange.bound(e,1e3+e,!1,!0)).onsuccess=function(e){var t,n,a;(e=e.target.result)?(t=document.createElement("option"),n=e.value.indexOf("\t"),M3.c==M3.q&&(M3.v=e.value),stageL?(a=e.value.slice(n+1,e.value.indexOf("\t",n+1)),1==stageL?t.textContent=a||QQ:t.textContent=[e.value.slice(0,n),a].filter(e=>e).join("/")):(t.textContent=e.value.slice(0,n),t.textContent||(t.textContent=e.value.slice(n+1,e.value.indexOf("\t",n+1))||QQ)),M3.appendChild(t),e.continue(),M3.c+=1):(M3.selectedIndex=M3.q,M3.oninput())}}function makeTd(e,t){var n=document.createElement("td");n.textContent=t,e.appendChild(n)}function t3str(e){var t=e.toString();switch(t.length){case 2:return"0"+t;case 1:return"00"+t}return t}function parse_drop(e){return e.split("|").map(function(e){return e.split(",")})}function getDropData(e){for(var t=[],n=0,a=[],o=0,i=e;o<i.length;o++){var s=i[o];a.push(parseInt(s[0],10))}for(var r=0,d=a;r<d.length;r++)n+=p=d[r];if(1e3==n)for(var l=0,c=a;l<c.length;l++){var p=c[l];t.push(numStr(p/10))}else if("-3"==info3[SI_RAND])for(var u=Math.floor(100/e.length).toString(),m=0,h=a;m<h.length;m++){p=h[m];t.push(u)}else if(100==n)for(var f=0,g=a;f<g.length;f++){p=g[f];t.push(p.toString())}else if(100<n&&("0"==info3[SI_RAND]||"1"==info3[SI_RAND])){var _=100;if(100==a[0]){t.push("100");for(var C=1;C<a.length;++C)_-=E=_*a[C]/100,t.push(numStr(E))}else for(var E,M=0,I=a;M<I.length;M++)_-=E=_*(p=I[M])/100,t.push(numStr(E))}else if("-4"==info3[SI_RAND])for(var S=0,y=a;S<y.length;S++){p=y[S];t.push(numStr(100*p/n))}else for(var v=0,x=a;v<x.length;v++){p=x[v];t.push(p.toString())}return t}function render_stage(){var j,a=parseInt(info2[SM_FLAGS]||"0",36),e=parseInt(info3[SI_FLAGS]||"0",36),t=info2[SM_STARS]?info2[SM_STARS].split(","):[],n=x=new URL(location.protocol+"//"+location.host+location.pathname),o=(n.searchParams.set("s",[M1.selectedIndex,M2.selectedIndex,M3.selectedIndex].join("-")),1!=(star=t.length?Math.min(t.length,star):1)&&n.searchParams.set("star",star.toString()),history.pushState({},"",n),stName.textContent=[info1[MC_TW_NAME]||QQ,info2[SM_TW_NAME]||QQ,info3[SI_TW_NAME]||QQ].join(" - "),stName2.textContent=[info1[MC_JP_NAME]||QQ,info2[SM_JP_NAME]||QQ,info3[SI_JP_NAME]||QQ].join(" - "),document.title=(info2[SI_TW_NAME]||info2[SI_JP_NAME]||QQ)+" - "+(info3[SI_TW_NAME]||info3[SI_JP_NAME]||QQ),document.getElementById("stars-tr")),o=(o&&o.parentNode.removeChild(o),document.getElementById("warn-tr")),o=(o&&o.parentNode.removeChild(o),document.getElementById("limit-bt")),s=(o&&o.parentNode.removeChild(o),100);if(t.length){var s=parseInt(t[star-1],10),i=document.createElement("tr");(A=document.createElement("th")).colSpan=6;for(let e=0;e<t.length;++e){var r=document.createElement("a");r.classList.add("star"),r.textContent=(e+1).toString()+"★: "+t[e]+"%",n.searchParams.set("star",(e+1).toString()),r.href=n.href,r.i=e,r.onclick=function(){return star=this.i+1,M3.oninput(),!1},(star||e)&&star-1!=e||r.classList.add("W"),A.appendChild(r)}i.appendChild(A),i.id="stars-tr",stName.parentNode.parentNode.appendChild(i)}if((info3[SI_FLAGS]||info2[SM_RESETMODE]||info1[MC_GOLDCPU]||info2[SM_WAITFORTIMER]||info2[SM_FLAGS]||info2[SM_SPECIALCOND])&&(i=document.createElement("tr"),A=document.createElement("th"),i.style.fontSize="larger",A.colSpan=6,info2[SM_RESETMODE]&&((I=document.createElement("div")).textContent=["過關獎勵將會在再次出現時重置","清除狀況將會在再次出現時重置","可過關次數將會在再次出現時重置"][info2[SM_RESETMODE].charCodeAt(0)-48],I.classList.add("I"),A.appendChild(I)),info2[SM_WAITFORTIMER]&&((I=document.createElement("div")).classList.add("W"),I.textContent="成功挑戰冷卻時長："+info2[SM_WAITFORTIMER],A.appendChild(I)),1&a&&((I=document.createElement("div")).classList.add("I"),I.textContent="全破後隱藏",A.appendChild(I)),(info1[MC_GOLDCPU]||2&a)&&((I=document.createElement("div")).classList.add("W"),I.textContent="※掃蕩不可※",A.appendChild(I)),1&e&&((I=document.createElement("div")).classList.add("w"),I.textContent="※接關不可※",A.appendChild(I)),2&e&&((I=document.createElement("div")).classList.add("w"),I.textContent="※速攻不可（城堡盾）※",A.appendChild(I)),info2[SM_SPECIALCOND]&&((I=document.createElement("div")).classList.add("w"),I.textContent=info2[SM_SPECIALCOND],A.appendChild(I),info2[SM_INVALID_COMBO])&&((I=document.createElement("div")).classList.add("W"),I.textContent=info2[SM_INVALID_COMBO],A.appendChild(I)),i.appendChild(A),i.id="warn-tr",stName.parentNode.parentNode.appendChild(i)),rewards.textContent="",info3[SI_DROP]&&3!=M1.selectedIndex)for(var d=getDropData(h=parse_drop(info3[SI_DROP])),l=0;l<h.length;++l)parseInt(d[l],10)&&(_=h[l],i=document.createElement("tr"),C=document.createElement("td"),E=document.createElement("td"),C.appendChild(document.createTextNode(d[l]+"%"+(0==l&&"100"!=_[0]&&"-4"!=info3[SI_RAND]?" （寶雷）":""))),E.textContent=0==l&&("1"==info3[SI_RAND]||1e3<=parseInt(h[0][1],10)&&parseInt(h[0][1],10)<3e4)?"一次":"無",createReward(i,_),i.appendChild(C),i.appendChild(E),rewards.appendChild(i));rewards.children.length?rewards.parentNode.style.display="table":rewards.parentNode.style.display="none",m_drops.textContent="";for(var c,p,u,m=info2[SM_MATERIALDROP].split(","),l=1;l<m.length;++l){let e=parseInt(m[l],36);"0"!=e&&(c=new Image(128,128),p=materialDrops[l-1],c.style.maxWidth="2.7em",c.style.height="auto",c.src="/img/r/gatyaitemD_".concat(duo(p),"_f.png"),E=document.createElement("td"),i=document.createElement("tr"),(u=document.createElement("td")).textContent=RWNAME[p],i.appendChild(u),E.appendChild(c),i.appendChild(E),(C=document.createElement("td")).textContent=e+"%",i.appendChild(C),m_drops.appendChild(i))}if(m_drops.children.length?m_drops.parentNode.style.display="table":m_drops.parentNode.style.display="none",mM.textContent="抽選次數：".concat(~~Math.round(parseInt(info3[SI_MAXMATERIAL],10)*parseFloat(info2[SM_MULTIPLIER].split(",")[star-1])),"回"),info3[SI_TIME]){m_times.textContent="";for(var h,f=0,g=h=parse_drop(info3[SI_TIME]);f<g.length;f++){var _=g[f],i=document.createElement("tr"),C=document.createElement("td"),E=document.createElement("td");C.textContent=_[2],E.textContent=_[0],createReward(i,_),i.appendChild(C),i.appendChild(E),m_times.appendChild(i)}m_times.parentNode.style.display="table"}else m_times.parentNode.style.display="none";var M,o=parseInt(info3[SI_ENERGY],36),a=(st1[1].textContent="/stages/14"==M1.selectedOptions[0].value?"喵力達"+String.fromCharCode(65+o/1e3)+"×"+(o%1e3).toString():o,st1[3].textContent=info3[SI_MAX],st1[5].textContent=info3[SI_LEN],info2[SM_MAPCOND]?(st3[3].textContent="",st3[3].appendChild(getConditionHTML(info2[SM_MAPCOND]))):st3[3].textContent="無限制",st2[1].textContent=8&e?~~(parseInt(info3[SI_HEALTH],10)*s/100):info3[SI_HEALTH],info2[SM_STAGECOND]?(st3[5].textContent="",st3[5].appendChild(getConditionHTML(info2[SM_STAGECOND]))):st3[5].textContent="無限制",0),I=("0"==info3[SI_XP]?3==M1.selectedIndex&&(a=1e3+300*Math.min(M3.selectedIndex,47)):a=parseInt(info3[SI_XP],36),st2[5].textContent=info3[SI_BG],st2[3].textContent=info3[SI_MIN_SPAWN]+"F",1.95*a);if([0,9,16].includes(M1.selectedIndex)&&(I*=9),st3[1].textContent=(~~I).toString(),stLines.textContent="",info2[SM_LIMIT]){for(var S=info2[SM_LIMIT].split("|").map(e=>Limit),y=star-1,v=new Limit,b=0;b<S.length;b++){var N=S[b];-1!=N.star&&N.star!=y||-1!=N.sid&&N.sid!=M3.selectedIndex||v.combine(N)}var A,o=[];v.rare&&o.push("稀有度:"+getRarityString(v.rare)),v.num&&o.push("最多可出戰角色數量:"+v.num),v.max&&v.min?o.push("生產成本".concat(v.min,"元與").concat(v.max,"元之間")):v.max?o.push("生產成本".concat(v.max,"元以下")):v.min&&o.push("生產成本".concat(v.min,"元以上")),v.line&&o.push("出陣列表:僅限第1頁"),v.group&&v.group[1].length&&o.push("可出擊角色的ID: "+v.group[1].join("/")),o.length&&(i=document.createElement("tr"),A=document.createElement("th"),(e=document.createElement("div")).textContent="※出擊限制※："+o.join("、"),e.classList.add("W"),i.style.fontSize="larger",A.colSpan=6,A.appendChild(e),i.appendChild(A),i.id="limit-bt",stName.parentNode.parentNode.appendChild(i))}ex_stages.textContent="";let L=info3[SI_EX_STAGE];if(L){if(ex_stages.style.display="block",(L=L.split("$"))[0]){let[e,o,t,n]=L[0].split(",");a=document.createElement("div"),I=(a.textContent=t!=n?"100"==e?"必定出現以下EX關卡：（各EX關卡平分出現機率）":"EX關卡：（出現機率："+e+"%，各EX關卡平分出現機率）":"100"==e?"必定出現以下EX關卡：":"EX關卡：（出現機率："+e+"%）",ex_stages.appendChild(a),4e6+1e3*parseInt(o,10));db.transaction("stage").objectStore("stage").openCursor(IDBKeyRange.bound(I+parseInt(t,10),I+parseInt(n,10))).onsuccess=function(t){if(t=t.target.result){var n=document.createElement("div"),a=document.createElement("a");let e=~~(t.key/1e6);a.textContent=namefor(t.value),a.onclick=function(){M1.oninput(null,[4,o,e])},a.href=`/stage.html?s=4-${o}-`+e,n.appendChild(a),ex_stages.appendChild(n),t.continue()}}}else if(L[1]){let[s,r]=L[1].split("|");var o=document.createElement("table"),k=(o.classList.add("w3-table","w3-centered"),document.createElement("tbody"));let e=document.createElement("tr"),t=document.createElement("td"),n=document.createElement("td");t.textContent="EX關卡",n.textContent="機率",e.appendChild(t),e.appendChild(n),k.appendChild(e),o.appendChild(k),s=s.split(","),r=r.split(",");for(let i=0;i<s.length;++i){let e=parseInt(s[i],36);var T=~~(e/1e6),w=e%1e3,B=~~((e-1e6*T)/1e3);let t=document.createElement("td"),n=document.createElement("td"),a=document.createElement("tr"),o=document.createElement("a");o.href="/stage.html?s="+(o.sts=[T,B,w]).join("-"),o.onclick=function(e){return M1.oninput(null,this.sts),!1},db.transaction("stage").objectStore("stage").get(e).onsuccess=function(e){o.textContent=namefor(e.target.result)},t.appendChild(o),n.textContent=r[i]+"%",a.appendChild(t),a.appendChild(n),k.appendChild(a)}ex_stages.appendChild(o)}}else ex_stages.style.display="none";for(M of info3[SI_ENEMY_LINES].split("|")){var O=M.split(",");let t=document.createElement("tr"),e=document.createElement("a");var D=parseInt(O[0],36);let n=t3str(D),a=new Image(64,64);var R=s/100,P=document.createElement("td");let o,i;if(O[7].includes("+")?[o,i]=O[7].split("+"):o=i=O[7],o=parseInt(o,36),i=parseInt(i,36),makeTd(t,ENAME[D]||"?"),a.src="/img/e/"+n+"/enemy_icon_"+n+".png",2==O[6].length?(o=~~(o*R).toString()+"%",i=i.toString()+"%",e.href=`/enemy.html?id=${D}&mag=${o}&atkMag=`+i):(e.href=`/enemy.html?id=${D}&mag=${o}&atkMag=${i}&stageMag=`+s,o=~~(o*R).toString()+"%",i=~~(i*R).toString()+"%"),e.appendChild(a),P.appendChild(e),t.appendChild(P),makeTd(t,o==i?o:`HP:${o}, ATK:`+i),makeTd(t,O[1]||"無限"),makeTd(t,O[5]+"%"),makeTd(t,stageF?TI(O[2]):O[2]),O[3]?O[4]?makeTd(t,stageF?TI(O[3])+"~"+TI(O[4]):O[3]+"~"+O[4]):makeTd(t,O[3]):makeTd(t,"-"),makeTd(t,O[8]||""),2==O[6].length){let e=document.createElement("span");e.textContent="（敵塔）",e.classList.add("boss"),t.firstElementChild.appendChild(e)}if("2"==O[6][0]){let e=document.createElement("span");e.textContent="（BOSS、震波）",e.classList.add("boss"),t.firstElementChild.appendChild(e)}else if("1"==O[6][0]){let e=document.createElement("span");e.textContent="（BOSS）",e.classList.add("boss"),t.firstElementChild.appendChild(e)}stLines.appendChild(t)}}function add_result_stage(e,t,n){t=t.replaceAll(n,e=>"<span>"+e+"</span>");let a=document.createElement("a");a.classList.add("res");var n=~~(e/1e6),o=~~((e-1e6*n)/1e3);a.href=`/stage.html?s=${n}-${o}-`+e%1e3,a.id=e,a.onclick=function(){var e=~~(this.id/1e6),t=this.id%1e3,n=~~((this.id-1e6*e)/1e3);return search_result.style.display="none",main_div.style.display="block",M1.oninput(null,[e,n,t]),!1},search_result.appendChild(a),a.v=stages_top[n][MC_TW_NAME]+" - ",a.e=t,db.transaction("map").objectStore("map").get(1e3*n+o).onsuccess=function(e){e=e.target.result,a.innerHTML=a.v+namefor(e)+" - "+a.e}}function add_result_map(e,t,n){t=t.replaceAll(n,e=>"<span>"+e+"</span>");var n=document.createElement("a"),a=(n.classList.add("res"),e%1e3),o=~~(e/1e3);n.href=`/stage.html?s=${o}-`+a,n.id=e,n.onclick=function(){var e=this.id%1e3,t=~~(this.id/1e3);return search_result.style.display="none",main_div.style.display="block",M1.oninput(null,[t,e]),!1},search_result.appendChild(n),n.innerHTML=stages_top[o][MC_TW_NAME]+" - "+t}function doSearch(e){let a=e.value.trim();a?(main_div.style.display="none",search_result.style.display="block",search_result.textContent="",db.transaction("stage").objectStore("stage").openCursor().onsuccess=function(t){if(t=t.target.result){var n=t.value.indexOf("\t");let e=t.value.slice(0,n);(e.includes(a)||(n+=1,(e=t.value.slice(n,t.value.indexOf("\t",n))).includes(a)))&&add_result_stage(t.key,e,a),t.continue()}else db.transaction("map").objectStore("map").openCursor(IDBKeyRange.lowerBound(0)).onsuccess=function(t){if(t=t.target.result){var n=t.value.indexOf("\t");let e=t.value.slice(0,n);(e.includes(a)||(n+=1,(e=t.value.slice(n,t.value.indexOf("\t",n))).includes(a)))&&add_result_map(t.key,e,a),t.continue()}else search_result.textContent||(search_result.textContent="找不到名稱包含「"+a+"」的關卡")}}):(search_result.style.display="none",main_div.style.display="block")}function wait(n){return new Promise(function(e,t){n.oncomplete=e,n.onerror=t})}async function load_all(){let e,t,n=0,a=0,o=await(await fetch("/data/map")).text(),i=db.transaction("map","readwrite"),s=i.objectStore("map");e:for(;;){for(;a<1e3;){for(e=n;"\t"!=o[n];)++n;for(t=n;"\n"!=o[n];)++n;if(s.put(o.slice(t+1,n),parseInt(o.slice(e,t),36)),++n>=o.length){await wait(i);break e}++a}await wait(i),a=0,i=db.transaction("map","readwrite"),s=i.objectStore("map")}a=0,n=0,o=await(await fetch("/data/stage")).text(),i=db.transaction("stage","readwrite"),s=i.objectStore("stage");e:for(;;){for(;a<1e3;){for(e=n;"\t"!=o[n];)++n;for(t=n;"\n"!=o[n];)++n;if(s.put(o.slice(t+1,n),parseInt(o.slice(e,t),36)),++n>=o.length){await wait(i);break e}++a}await wait(i),a=0,i=db.transaction("stage","readwrite"),s=i.objectStore("stage")}(char_groups=await(await fetch("/data/group")).json()).ver=13500,db.transaction("map","readwrite").objectStore("map").put(char_groups,-1).onsuccess=initUI}M1.oninput=function(e,o){o&&o.length&&(M1.selectedIndex=o[0]);var t=1e3*M1.selectedIndex;M2.length="",M3.length="",info1=stages_top[M1.selectedIndex],M2.c=0,o&&1<o.length?M2.q=o[1]:M2.q=0,db.transaction("map").objectStore("map").openCursor(IDBKeyRange.bound(t,1e3+t,!1,!0)).onsuccess=function(e){var t,n,a;(e=e.target.result)?(t=document.createElement("option"),n=e.value.indexOf("\t"),M2.c==M2.q&&(M2.v=e.value),stageL?(a=e.value.slice(n+1,e.value.indexOf("\t",n+1)),1==stageL?t.textContent=a||QQ:t.textContent=[e.value.slice(0,n),a].filter(e=>e).join("/")):(t.textContent=e.value.slice(0,n),t.textContent||(t.textContent=e.value.slice(n+1,e.value.indexOf("\t",n+1))||QQ)),M2.appendChild(t),e.continue(),M2.c+=1):(M2.selectedIndex=M2.q,M2.oninput(null,o))}},M2.oninput=function(e,t){M3.length="",M3.c=0,t&&2<t.length?M3.q=t[2]:M3.q=0,M2.v?(info2=M2.v.split("\t"),M2.v=null,process_2()):db.transaction("map").objectStore("map").get(1e3*M1.selectedIndex+M2.selectedIndex).onsuccess=function(e){info2=e.target.result.split("\t"),process_2()}},M3.oninput=function(){M3.v?(info3=M3.v.split("\t"),M3.v=null,render_stage()):db.transaction("stage").objectStore("stage").get(1e6*M1.selectedIndex+1e3*M2.selectedIndex+M3.selectedIndex).onsuccess=function(e){info3=e.target.result.split("\t"),render_stage()}},document.getElementById("form").onsubmit=function(e){return e.preventDefault(),setTimeout(doSearch,0,e.currentTarget.firstElementChild),!1};let req=indexedDB.open("stage_v2");req.onupgradeneeded=function(e){(db=e.target.result).objectStoreNames.contains("map")||db.createObjectStore("map"),db.objectStoreNames.contains("stage")||db.createObjectStore("stage")},req.onsuccess=function(e){(db=e.target.result).transaction("map").objectStore("map").get(-1).onsuccess=function(e){((char_groups=e.target.result)&&13500==char_groups.ver?initUI:load_all)()}};